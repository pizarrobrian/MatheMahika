<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Registration - MatheMahika</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 500px;
        }

        .app-wrapper {
            display: flex;
            width: 100%;
            max-width: 1600px;
            gap: 20px;
        }

        .sidebar {
            width: 280px;
            background-color: #fff4d6;
            border-radius: 24px;
            padding: 24px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 12px 24px rgba(255, 183, 77, 0.2);
        }

        .sidebar h2 {
            color: #ff6f61;
            font-size: 22px;
            margin-bottom: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 18px;
            border-radius: 16px;
            color: #ff6f61;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            background-color: rgba(255, 255, 255, 0.8);
            border: 2px solid transparent;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .nav-item:hover::before {
            left: 100%;
        }

        .nav-item.active,
        .nav-item:hover {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: #fff;
            box-shadow: 0 12px 24px rgba(255, 154, 158, 0.35);
            border-color: rgba(255, 159, 150, 0.4);
        }

        .nav-item span {
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            background: white;
            border-radius: 28px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
            max-height: calc(100vh - 40px);
            min-width: 0;
        }

        .content-section {
            flex: 1;
            padding: 32px 40px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 28px;
            opacity: 1;
            transform: translateX(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .content-section.hidden {
            display: none;
            opacity: 0;
            transform: translateX(20px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h1 {
            font-size: 28px;
            color: #2d3a60;
        }

        .section-header small {
            color: #6c7aa0;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
            margin-bottom: 8px;
        }

        .cards-grid--four {
            grid-template-columns: repeat(4, minmax(0, 1fr));
            align-items: stretch;
        }

        .dash-card {
            background: #ffffff;
            border-radius: 20px;
            padding: 24px;
            border: 2px solid rgba(255, 185, 128, 0.35);
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 12px 30px rgba(255, 173, 96, 0.22);
        }

        .dash-card h3 {
            font-size: 13px;
            text-transform: uppercase;
            color: #ff6f61;
            margin-bottom: 8px;
            letter-spacing: 0.08em;
        }

        .dash-card strong {
            font-size: 34px;
            color: #2f3e46;
        }

        .chart-placeholder {
            height: 200px;
            border-radius: 16px;
            border: 2px dashed rgba(255, 154, 158, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ff6f61;
            font-weight: 600;
        }

        .subheading {
            font-size: 20px;
            margin-bottom: 16px;
            color: #ff6f61;
        }

        .table-card {
            background: #fffdf6;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid rgba(255, 193, 7, 0.25);
            margin-bottom: 24px;
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .table-card table {
            width: 100%;
            border-collapse: collapse;
        }

        .table-card--list {
            overflow-x: auto;
        }

        .table-card--list table {
            min-width: 640px;
        }

        .table-card th,
        .table-card td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 193, 7, 0.18);
        }

        .table-card th {
            text-transform: uppercase;
            font-size: 12px;
            color: #f28482;
            letter-spacing: 0.08em;
            background-color: rgba(255, 223, 186, 0.6);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table-card tbody tr:hover {
            background-color: rgba(255, 210, 140, 0.18);
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background-color: rgba(255, 182, 193, 0.25);
            color: #ff6f61;
            border-radius: 999px;
            padding: 6px 12px;
            font-weight: 600;
            font-size: 12px;
        }

        .quiz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .quiz-card {
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(79, 195, 247, 0.25);
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 10px 22px rgba(79, 195, 247, 0.18);
        }

        .quiz-card h3 {
            color: #2f3e46;
        }

        .progress-bar {
            height: 12px;
            background-color: rgba(255, 182, 193, 0.3);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar span {
            display: block;
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(135deg, #4cc9f0 0%, #ffafcc 100%);
        }

        .data-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .data-card {
            border-radius: 16px;
            padding: 20px;
            border: 2px solid rgba(79, 195, 247, 0.25);
            background: #ffffff;
            box-shadow: 0 10px 24px rgba(79, 195, 247, 0.18);
        }

        .data-card h3 {
            color: #ff6f61;
            margin-bottom: 12px;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: rgba(255, 215, 128, 0.25);
            color: #ff6f61;
            border-radius: 999px;
            font-weight: 600;
            font-size: 12px;
        }

        .split-layout {
            display: grid;
            grid-template-columns: minmax(380px, 420px) minmax(0, 1fr);
            gap: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #ff9a9e;
        }

        .form-group input:read-only {
            background-color: #f8f9fa;
            color: #6c757d;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(255, 154, 158, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            z-index: 1000;
        }

        .connection-status.connected {
            background-color: #d4edda;
            color: #155724;
        }

        .connection-status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }

        .user-row-actions {
            display: flex;
            gap: 10px;
        }

        .small-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background-color: rgba(255, 182, 193, 0.25);
            color: #ff6f61;
            transition: background 0.25s ease;
        }

        .small-btn:hover {
            background-color: rgba(255, 182, 193, 0.4);
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff9a9e;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-link {
            text-align: center;
            margin-top: 20px;
        }

        .back-link a {
            color: #ff6f61;
            text-decoration: none;
            font-weight: 600;
        }

        .back-link a:hover {
            text-decoration: underline;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #ff9a9e;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            color: #333;
            font-weight: 500;
            user-select: none;
        }

        .checkbox-group a {
            color: #ff6f61;
            text-decoration: none;
            font-weight: 600;
        }

        .checkbox-group a:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none !important;
        }

        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
            font-size: 24px;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #666;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-body {
            color: #333;
            line-height: 1.8;
        }

        .modal-body h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .modal-body p {
            margin-bottom: 15px;
        }

        .modal-body ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-body li {
            margin-bottom: 8px;
        }

        /* Question Row Styles */
        .question-row {
            display: grid;
            grid-template-columns: 1fr 60px 1fr 80px 1fr 40px;
            gap: 8px;
            align-items: center;
            padding: 12px;
            background-color: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .question-row input,
        .question-row select {
            padding: 8px 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .question-row input:focus,
        .question-row select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .question-row .operator-select {
            text-align: center;
            font-weight: 600;
        }

        .question-row .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .question-row .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* View Quiz Problem Styles */
        .problem-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            font-size: 16px;
        }

        .problem-number {
            background-color: #667eea;
            color: white;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            min-width: 32px;
            text-align: center;
        }

        .problem-equation {
            flex: 1;
            font-family: 'Segoe UI', system-ui, sans-serif;
            font-size: 18px;
            color: #323f90;
            font-weight: 500;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Custom scrollbar styling */
        .content-section::-webkit-scrollbar {
            width: 8px;
        }

        .content-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .content-section::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 4px;
        }

        .content-section::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Student View Modal Styling */
        #studentViewModal .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }

        #studentViewContent {
            max-height: 70vh;
            overflow-y: auto;
        }

        #studentViewContent::-webkit-scrollbar {
            width: 6px;
        }
        
        #studentViewContent::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 3px;
        }
        
        #studentViewContent::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }
        
        #studentViewContent::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* Scrollbar for table container */
        .table-card--list > div::-webkit-scrollbar {
            width: 10px;
        }

        .table-card--list > div::-webkit-scrollbar-track {
            background: #f8f9fe;
            border-radius: 5px;
        }

        .table-card--list > div::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
        }

        .table-card--list > div::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Leaderboard Styles */
        .leaderboard-row {
            background: #f8f9fe;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .leaderboard-row:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }

        .leaderboard-row.rank-1 {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-color: #ffd700;
        }

        .leaderboard-row.rank-2 {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            border-color: #c0c0c0;
        }

        .leaderboard-row.rank-3 {
            background: linear-gradient(135deg, #cd7f32 0%, #e9a66f 100%);
            border-color: #cd7f32;
        }

        .rank-badge {
            font-size: 28px;
            font-weight: 700;
            white-space: nowrap;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-size: 22px;
            font-weight: 700;
            color: #323f90;
            margin-bottom: 8px;
        }

        .player-score {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .filter-btn {
            padding: 10px 18px !important;
            border-radius: 20px !important;
            transition: all 0.3s ease !important;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }

        /* Improve table responsiveness */
        .table-card--list {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .table-card--list table {
            min-width: 640px;
        }

        /* Add loading state for better UX */
        .loading-section {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            color: #6c7aa0;
            font-size: 16px;
        }

        @media (max-width: 1400px) {
            .app-wrapper {
                max-width: 1400px;
            }
        }

        @media (max-width: 1024px) {
            body {
                padding: 16px;
                align-items: flex-start;
            }

            .app-wrapper {
                flex-direction: column;
                max-width: 100%;
                height: calc(100vh - 32px);
            }

            .sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                gap: 8px;
                padding: 12px;
                flex-shrink: 0;
            }

            .sidebar h2 {
                flex: 1 0 100%;
                margin-bottom: 8px;
            }

            .nav-item {
                flex: 0 0 auto;
                padding: 10px 14px;
                border-radius: 12px;
            }

            .main-content {
                height: calc(100vh - 200px);
                max-height: calc(100vh - 200px);
            }

            .content-section {
                padding: 24px;
            }

            .split-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .cards-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .pill {
                align-self: flex-end;
            }

            .table-card {
                padding: 18px;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 12px;
            }

            .container {
                padding: 28px 24px;
            }

            .app-wrapper {
                height: calc(100vh - 24px);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .sidebar {
                flex-wrap: wrap;
                height: auto;
                min-height: 120px;
            }

            .nav-item {
                flex: 1 1 calc(50% - 8px);
                justify-content: center;
            }

            .main-content {
                height: calc(100vh - 180px);
                max-height: calc(100vh - 180px);
            }

            .content-section {
                padding: 20px;
            }

            .quiz-grid,
            .data-section {
                grid-template-columns: 1fr;
            }

            .chart-placeholder {
                height: 160px;
            }

            .connection-status {
                position: static;
                margin-bottom: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- Terms and Conditions Modal -->
    <div id="termsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>📋 Terms and Conditions</h2>
                <button class="modal-close" onclick="closeTermsModal()">&times;</button>
            </div>
            <div class="modal-body">
                
                
                <h3>1. Acceptance of Terms</h3>
                <p>By accessing the MatheMahika Admin Panel, you acknowledge that you have read, understood, and agree to be bound by these Terms and Conditions. If you do not agree, please do not use this system.</p>
                
                <h3>2. Admin Responsibilities</h3>
                <p>As an administrator, you agree to:</p>
                <ul>
                    <li>Maintain the confidentiality of your login credentials</li>
                    <li>Use the system responsibly and ethically</li>
                    <li>Protect student data and privacy at all times</li>
                    <li>Not share access with unauthorized individuals</li>
                    <li>Report any security concerns immediately</li>
                </ul>
                
                <h3>3. Data Privacy and Security</h3>
                <p>You must comply with all applicable data protection laws and regulations. Student information must be handled with the utmost care and used only for legitimate educational purposes.</p>
                
                <h3>4. Prohibited Activities</h3>
                <p>The following activities are strictly prohibited:</p>
                <ul>
                    <li>Unauthorized access or attempted access to restricted areas</li>
                    <li>Modification or deletion of data without proper authorization</li>
                    <li>Sharing or distributing student information without consent</li>
                    <li>Using the system for any illegal or unethical purposes</li>
                </ul>
                
                <h3>5. System Availability</h3>
                <p>While we strive to maintain system availability, we do not guarantee uninterrupted access. The system may be unavailable due to maintenance, updates, or technical issues.</p>
                
                <h3>6. Changes to Terms</h3>
                <p>We reserve the right to modify these Terms and Conditions at any time. Continued use of the system after changes constitutes acceptance of the modified terms.</p>
                
                <h3>7. Contact Information</h3>
                <p>For questions or concerns regarding these terms, please contact the system administrator.</p>
                
                <p style="margin-top: 20px;"><em>By checking the agreement box and logging in, you confirm that you have read and accept these Terms and Conditions.</em></p>
            </div>
        </div>
    </div>

    <!-- Edit Student Password Modal -->
    <div id="editPasswordModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>🔑 Edit Student Password</h2>
                <button class="modal-close" onclick="closeEditPasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #6c7aa0;">Update the password for <strong id="editStudentName" style="color: #323f90;"></strong></p>
                
                <form id="editPasswordForm" onsubmit="saveNewPassword(event)">
                    <div class="form-group">
                        <label for="newStudentPassword">New Password:</label>
                        <input type="password" id="newStudentPassword" name="newStudentPassword" required placeholder="Enter new password" minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmStudentPassword">Confirm Password:</label>
                        <input type="password" id="confirmStudentPassword" name="confirmStudentPassword" required placeholder="Confirm new password" minlength="6">
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button type="submit" class="btn btn-primary" id="savePasswordBtn">
                            Save Password
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditPasswordModal()">
                            Cancel
                        </button>
                    </div>
                </form>

                <div id="editPasswordMessage" class="message" style="display: none; margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <!-- Add Quiz Modal -->
    <div id="addQuizModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>➕ Add New Quiz</h2>
                <button class="modal-close" onclick="closeAddQuizModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addQuizForm" onsubmit="saveQuiz(event)">
                    <!-- Quiz Name -->
                    <div class="form-group">
                        <label for="quizName">Quiz Name:</label>
                        <input type="text" id="quizName" name="quizName" required placeholder="Enter quiz name (e.g., Math Challenge Level 1)">
                    </div>

                    <!-- Quiz Type Selection -->
                    <div class="form-group">
                        <label for="quizType">Quiz Type:</label>
                        <select id="quizType" name="quizType" required onchange="updateOperationOptions()">
                            <option value="">-- Select Quiz Type --</option>
                            <option value="openworld">🌍 Open World (Mixed Operations)</option>
                            <option value="claw_addition">🎯 Claw Machine - Addition</option>
                            <option value="claw_subtraction">🎯 Claw Machine - Subtraction</option>
                            <option value="claw_multiplication">🎯 Claw Machine - Multiplication</option>
                            <option value="claw_division">🎯 Claw Machine - Division</option>
                            <option value="clawmachine">🎮 Claw Machine (Legacy - Manual Operation)</option>
                        </select>
                    </div>

                    <!-- Operation Selection (for Claw Machine only) -->
                    <div class="form-group" id="operationGroup" style="display: none;">
                        <label for="quizOperation">Operation:</label>
                        <select id="quizOperation" name="quizOperation">
                            <option value="">-- Select Operation --</option>
                            <option value="addition">➕ Addition</option>
                            <option value="subtraction">➖ Subtraction</option>
                            <option value="multiplication">✖️ Multiplication</option>
                            <option value="division">➗ Division</option>
                        </select>
                    </div>

                    <!-- Attempts -->
                    <div class="form-group">
                        <label for="quizAttempts">Attempts Allowed:</label>
                        <input type="number" id="quizAttempts" name="quizAttempts" required min="1" max="10" placeholder="Enter number of attempts (1-10)" value="3">
                    </div>

                    <!-- Score Per Question -->
                    <div class="form-group">
                        <label for="quizScore">Score Per Correct Answer:</label>
                        <input type="number" id="quizScore" name="quizScore" required min="1" max="100" placeholder="Enter points per correct answer (e.g., 5)" value="5">
                        <small style="color: #6c7aa0; font-size: 12px; margin-top: 4px; display: block;">Each correct answer will be worth this many points</small>
                    </div>

                    <!-- Set Time Limit -->
                    <div class="form-group">
                        <label for="quizTimeLimit">Time Limit (minutes):</label>
                        <input type="number" id="quizTimeLimit" name="quizTimeLimit" required min="1" max="180" placeholder="Enter time limit in minutes (e.g., 30)" value="30">
                        <small style="color: #6c7aa0; font-size: 12px; margin-top: 4px; display: block;">Students must complete the quiz within this time</small>
                    </div>

                    <!-- Set Deadline -->
                    <div class="form-group">
                        <label for="quizDeadline">Deadline:</label>
                        <input type="datetime-local" id="quizDeadline" name="quizDeadline" required>
                        <small style="color: #6c7aa0; font-size: 12px; margin-top: 4px; display: block;">Quiz will be unavailable after this date and time</small>
                    </div>

                    <!-- Questions Section -->
                    <div class="form-group">
                        <label>Questions:</label>
                        <div id="questionsContainer" style="margin-top: 12px;">
                            <!-- Questions will be dynamically added here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addQuestionRow()" style="margin-top: 12px; width: auto; padding: 8px 16px;">
                            ➕ Add Question
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button type="submit" class="btn btn-primary">
                            💾 Save Quiz
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeAddQuizModal()">
                            Cancel
                        </button>
                    </div>
                </form>

                <div id="addQuizMessage" class="message" style="display: none; margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <!-- View Quiz Modal -->
    <div id="viewQuizModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 id="viewQuizTitle">📝 Quiz Details</h2>
                <button class="modal-close" onclick="closeViewQuizModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Quiz Problems -->
                <h3 style="color: #323f90; margin-bottom: 16px;">Problems:</h3>
                <div id="viewQuizProblems" style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 32px;">
                    <!-- Problems will be dynamically loaded here -->
                </div>

                <!-- Student Results -->
                <h3 style="color: #323f90; margin-bottom: 16px;">Student Results:</h3>
                <div style="max-height: 400px; overflow-y: auto; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                    <table id="viewQuizStudentsTable" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Score</th>
                                <th>✅ Correct</th>
                                <th>❌ Incorrect</th>
                                <th>Time Taken</th>
                                <th>Answered</th>
                                <th>Attempts Used</th>
                            </tr>
                        </thead>
                        <tbody id="viewQuizStudentsTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px; color: #6c7aa0;">
                                    No students have taken this quiz yet.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="closeViewQuizModal()">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Student View Modal -->
    <div id="studentViewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>👤 Student Profile</h2>
                <button class="modal-close" onclick="closeStudentViewModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="studentViewContent">
                    <!-- Student information will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Quiz Modal -->
    <div id="editQuizModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>✏️ Edit Quiz</h2>
                <button class="modal-close" onclick="closeEditQuizModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editQuizForm" onsubmit="updateQuiz(event)">
                    <input type="hidden" id="editQuizId" name="editQuizId">
                    
                    <!-- Quiz Name -->
                    <div class="form-group">
                        <label for="editQuizName">Quiz Name:</label>
                        <input type="text" id="editQuizName" name="editQuizName" required placeholder="Enter quiz name">
                    </div>

                    <!-- Quiz Type Selection -->
                    <div class="form-group">
                        <label for="editQuizType">Quiz Type:</label>
                        <select id="editQuizType" name="editQuizType" required onchange="updateEditOperationOptions()">
                            <option value="">-- Select Quiz Type --</option>
                            <option value="openworld">🌍 Open World (Mixed Operations)</option>
                            <option value="claw_addition">🎯 Claw Machine - Addition</option>
                            <option value="claw_subtraction">🎯 Claw Machine - Subtraction</option>
                            <option value="claw_multiplication">🎯 Claw Machine - Multiplication</option>
                            <option value="claw_division">🎯 Claw Machine - Division</option>
                        </select>
                    </div>

                    <!-- Operation Selection (for Claw Machine only) -->
                    <div class="form-group" id="editOperationGroup" style="display: none;">
                        <label for="editQuizOperation">Operation:</label>
                        <select id="editQuizOperation" name="editQuizOperation">
                            <option value="">-- Select Operation --</option>
                            <option value="addition">➕ Addition</option>
                            <option value="subtraction">➖ Subtraction</option>
                            <option value="multiplication">✖️ Multiplication</option>
                            <option value="division">➗ Division</option>
                        </select>
                    </div>

                    <!-- Attempts -->
                    <div class="form-group">
                        <label for="editQuizAttempts">Attempts Allowed:</label>
                        <input type="number" id="editQuizAttempts" name="editQuizAttempts" required min="1" max="10">
                    </div>

                    <!-- Score Per Question -->
                    <div class="form-group">
                        <label for="editQuizScore">Score Per Correct Answer:</label>
                        <input type="number" id="editQuizScore" name="editQuizScore" required min="1" max="100">
                    </div>

                    <!-- Set Time Limit -->
                    <div class="form-group">
                        <label for="editQuizTimeLimit">Time Limit (minutes):</label>
                        <input type="number" id="editQuizTimeLimit" name="editQuizTimeLimit" required min="1" max="180">
                    </div>

                    <!-- Set Deadline -->
                    <div class="form-group">
                        <label for="editQuizDeadline">Deadline:</label>
                        <input type="datetime-local" id="editQuizDeadline" name="editQuizDeadline" required>
                    </div>

                    <!-- Questions Section -->
                    <div class="form-group">
                        <label>Questions:</label>
                        <div id="editQuestionsContainer" style="margin-top: 12px;">
                            <!-- Questions will be dynamically loaded here -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addEditQuestionRow()" style="margin-top: 12px; width: auto; padding: 8px 16px;">
                            ➕ Add Question
                        </button>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button type="submit" class="btn btn-primary">
                            💾 Update Quiz
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditQuizModal()">
                            Cancel
                        </button>
                    </div>
                </form>

                <div id="editQuizMessage" class="message" style="display: none; margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <!-- Connection Status Indicator -->
    <div id="connectionStatus" class="connection-status disconnected hidden">
        🔴 Checking Connection...
    </div>

    <div id="adminLoginContainer" class="container">
        <div class="header">
            <h1>🔐 Admin Access</h1>
            <p>Please authenticate to manage MatheMahika</p>
        </div>

        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminUsername">Admin Username:</label>
                <input type="text" id="adminUsername" name="adminUsername" required placeholder="Enter admin username">
            </div>

            <div class="form-group">
                <label for="adminPassword">Admin Password:</label>
                <input type="password" id="adminPassword" name="adminPassword" required placeholder="Enter admin password">
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="adminTermsCheckbox" name="adminTermsCheckbox">
                <label for="adminTermsCheckbox">
                    I agree to the <a href="#" onclick="event.preventDefault(); openTermsModal();">Terms and Conditions</a>
                </label>
            </div>

            <button type="submit" class="btn btn-primary" id="adminLoginBtn">
                Sign In
            </button>
        </form>

        <div id="loginMessage" class="message" style="display: none;"></div>
    </div>

    <div id="registrationContainer" class="app-wrapper hidden">
        <aside class="sidebar">
            <h2>MatheMahika</h2>
            <div class="nav-item active" data-section="dashboard">
                <span>🏠</span>
                <div>Dashboard</div>
            </div>
            <div class="nav-item" data-section="students">
                <span>👥</span>
                <div>Students</div>
            </div>
            <div class="nav-item" data-section="quiz">
                <span>🧠</span>
                <div>Quiz</div>
            </div>
            <div class="nav-item" data-section="leaderboards">
                <span>🏆</span>
                <div>Leaderboards</div>
            </div>
            <div class="nav-item" data-section="reports">
                <span>📊</span>
                <div>Data Report</div>
            </div>
            <div class="nav-item" data-section="download">
                <span>📱</span>
                <div>Download App</div>
            </div>
            <div class="nav-item" data-section="account">
                <span>⚙️</span>
                <div>Manage Account</div>
            </div>
            <div class="nav-item" data-section="about">
                <span>ℹ️</span>
                <div>About</div>
            </div>
            <div class="nav-item" id="logoutBtn">
                <span>🚪</span>
                <div>Log out</div>
            </div>
        </aside>

        <main class="main-content">
            <section id="dashboardSection" class="content-section">
                <div class="dashboard-intro" style="display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #ffe29a 0%, #ff6f91 100%); padding: 24px 32px; border-radius: 24px; color: #fff; margin-bottom: 28px; box-shadow: 0 16px 32px rgba(255, 111, 145, 0.35);">
                    <div>
                        <h1 style="font-size: 32px; margin-bottom: 8px;">🎉 Welcome back, Teacher!</h1>
                        <p style="opacity: 0.9; font-size: 16px; max-width: 560px;">Here is a quick look at how your Grade 3 class is doing today. Track progress, celebrate wins, and plan your next fun math adventure!</p>
                    </div>
                    <img src="https://storage.googleapis.com/cursor-chat-data/0b9a5b8ad4e41497721b37f63270c673e4c3e12b4769b1ef28e8a4a3f8912d8d.png" alt="Kids Learning Illustration" style="width: 220px; max-width: 30%; border-radius: 16px;" loading="lazy">
                    </div>

                <div class="cards-grid cards-grid--four" style="margin-bottom: 28px;">
                    <div class="dash-card" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%); color: #fff;">
                        <h3>Students Playing Today</h3>
                        <strong id="dashboardActiveToday">0</strong>
                        <small style="opacity: 0.9; font-weight: 600;">Kids who logged in during school hours</small>
                    </div>
                    <div class="dash-card" style="background: linear-gradient(135deg, #a0e7ff 0%, #b5f5ff 100%); color: #085f63;">
                        <h3>Quizzes Completed</h3>
                        <strong id="dashboardQuizzesCompleted">0</strong>
                        <small style="opacity: 0.85; font-weight: 600;">Total quizzes finished today</small>
                    </div>
                    <div class="dash-card" style="background: linear-gradient(135deg, #ffdde1 0%, #ee9ca7 100%); color: #7a2843;">
                        <h3>Class Star</h3>
                        <strong id="dashboardClassStar">N/A</strong>
                        <small style="opacity: 0.85; font-weight: 600;">Highest scoring student today</small>
                    </div>
                    <div class="dash-card" style="background: linear-gradient(135deg, #c3f0ca 0%, #8fd3fe 100%); color: #1b3a4b;">
                        <h3>Math Skill Level</h3>
                        <strong id="dashboardSkillLevel">Growing 🌱</strong>
                        <small style="opacity: 0.85; font-weight: 600;">Based on overall class accuracy</small>
                    </div>
                </div>

                <div class="table-card" style="background: #ffffff; border: 2px solid rgba(255, 183, 77, 0.25); box-shadow: 0 18px 32px rgba(255, 183, 77, 0.25); margin-bottom: 32px;">
                    <div class="section-header" style="margin-bottom: 18px;">
                        <div>
                            <h2 style="font-size: 24px; color: #ff6f61;">🌟 Today’s Quick View</h2>
                            <small style="color: #6c7aa0; font-weight: 600;">Snapshot of student progress and achievements</small>
                    </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;">
                        <div style="background: rgba(255, 182, 193, 0.2); border: 2px dashed rgba(255, 182, 193, 0.6); border-radius: 16px; padding: 18px;">
                            <h3 style="color: #ff6f61; font-size: 16px; margin-bottom: 10px;">Most Loved Game</h3>
                            <p style="font-size: 32px; font-weight: 700; color: #ff6f61; margin-bottom: 6px;" id="dashboardTopGame">Loading...</p>
                            <small style="color: #7a2843;" id="dashboardTopGameDetail">Checking today’s favorites...</small>
                        </div>
                        <div style="background: rgba(160, 231, 255, 0.25); border: 2px dashed rgba(160, 231, 255, 0.55); border-radius: 16px; padding: 18px;">
                            <h3 style="color: #1b3a4b; font-size: 16px; margin-bottom: 10px;">Tricky Topic</h3>
                            <p style="font-size: 32px; font-weight: 700; color: #1b3a4b; margin-bottom: 6px;" id="dashboardTrickyTopic">Loading...</p>
                            <small style="color: #345d7e;" id="dashboardTrickyTopicDetail">Analyzing quiz results...</small>
                        </div>
                        <div style="background: rgba(195, 240, 202, 0.3); border: 2px dashed rgba(76, 175, 80, 0.45); border-radius: 16px; padding: 18px;">
                            <h3 style="color: #2f4f4f; font-size: 16px; margin-bottom: 10px;">Sweet Success</h3>
                            <p style="font-size: 32px; font-weight: 700; color: #2f4f4f; margin-bottom: 6px;" id="dashboardAverageScore">Loading...</p>
                            <small style="color: #3c6e71;" id="dashboardAverageScoreDetail">Gathering class results...</small>
                        </div>
                        <div style="background: rgba(255, 241, 186, 0.35); border: 2px dashed rgba(255, 224, 138, 0.55); border-radius: 16px; padding: 18px;">
                            <h3 style="color: #b17a00; font-size: 16px; margin-bottom: 10px;">Class Cheer</h3>
                            <p style="font-size: 32px; font-weight: 700; color: #b17a00; margin-bottom: 6px;" id="dashboardBadgesEarned">Loading...</p>
                            <small style="color: #b17a00;" id="dashboardBadgesDetail">Celebrating stars soon!</small>
                        </div>
                    </div>
                </div>

                <div class="table-card" style="background: #fffdf6; border: 2px solid rgba(255, 193, 7, 0.25);">
                    <div class="section-header" style="margin-bottom: 18px;">
                        <div>
                            <h2 style="font-size: 22px; color: #ff6f61;">🎯 Student Spotlight</h2>
                            <small style="color: #6c7aa0; font-weight: 600;">Great work happening right now!</small>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 18px;">
                        <div style="border-radius: 16px; padding: 18px; background: #ffffff; border: 2px solid rgba(255, 182, 193, 0.4); box-shadow: 0 12px 24px rgba(255, 182, 193, 0.25);">
                            <h4 style="margin: 0 0 8px 0; color: #ff6f61; font-size: 18px;">👧 Maria Santos</h4>
                            <p style="margin: 0; color: #7a2843; font-weight: 600;">Completed 3 quizzes today!</p>
                            <small style="color: #a25f7b;">Highest score: 98 in Open World</small>
                        </div>
                        <div style="border-radius: 16px; padding: 18px; background: #ffffff; border: 2px solid rgba(160, 231, 255, 0.45); box-shadow: 0 12px 24px rgba(160, 231, 255, 0.3);">
                            <h4 style="margin: 0 0 8px 0; color: #1b3a4b; font-size: 18px;">🧒 Carlos Reyes</h4>
                            <p style="margin: 0; color: #345d7e; font-weight: 600;">Improved division score by +15%</p>
                            <small style="color: #507091;">Keep cheering for steady progress!</small>
                        </div>
                        <div style="border-radius: 16px; padding: 18px; background: #ffffff; border: 2px solid rgba(195, 240, 202, 0.45); box-shadow: 0 12px 24px rgba(195, 240, 202, 0.35);">
                            <h4 style="margin: 0 0 8px 0; color: #2f4f4f; font-size: 18px;">👦 Juan Dela Cruz</h4>
                            <p style="margin: 0; color: #3c6e71; font-weight: 600;">First to finish the new challenge</p>
                            <small style="color: #3c6e71;">Badge earned: Fast Thinker</small>
                        </div>
                    </div>
                </div>
            </section>

            <section id="studentsSection" class="content-section hidden">
                <div class="table-card table-card--list">
                    <h3 class="subheading">All Students</h3>
                    <div class="tag">🪄 Auto-sync with Firebase</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>🎮 Claw Machine</th>
                                <th>🌍 Open World</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="studentsTableBody">
                            <tr>
                                <td>Juan Dela Cruz</td>
                                <td>juan@math.com</td>
                                <td>98</td>
                                <td>85</td>
                                <td>
                                    <div class="user-row-actions">
                                        <button class="small-btn">View</button>
                                        <button class="small-btn">Archive</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Maria Santos</td>
                                <td>maria@math.com</td>
                                <td>95</td>
                                <td>92</td>
                                <td>
                                    <div class="user-row-actions">
                                        <button class="small-btn">View</button>
                                        <button class="small-btn">Archive</button>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Carlos Reyes</td>
                                <td>carlos@math.com</td>
                                <td>92</td>
                                <td>88</td>
                                <td>
                                    <div class="user-row-actions">
                                        <button class="small-btn">View</button>
                                        <button class="small-btn">Archive</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="quizSection" class="content-section hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h2 style="color: #323f90; font-size: 24px; font-weight: 700;">Quiz Management</h2>
                    <button class="btn btn-primary" onclick="openAddQuizModal()" style="width: auto; padding: 12px 24px;">
                        ➕ Add Quiz
                    </button>
                </div>

                <div class="table-card table-card--list">
                    <h3 class="subheading">All Quizzes</h3>
                    <div class="tag">📝 Manage your quizzes</div>
                    <div style="max-height: 600px; overflow-y: auto; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1); margin-top: 20px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Quiz Name</th>
                                    <th>Quiz Type</th>
                                    <th>Operation</th>
                                    <th>Questions</th>
                                    <th>Attempts</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="quizzesTableBody">
                                <tr>
                                    <td>Math Challenge Level 1</td>
                                    <td>🌍 Open World</td>
                                    <td>Mixed Operations</td>
                                    <td>10 questions</td>
                                    <td>3</td>
                                    <td>Oct 10, 2025</td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn">👁️ View</button>
                                            <button class="small-btn">✏️ Edit</button>
                                            <button class="small-btn">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>Addition Practice</td>
                                    <td>🎮 Claw Machine</td>
                                    <td>Addition</td>
                                    <td>8 questions</td>
                                    <td>5</td>
                                    <td>Oct 9, 2025</td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn">👁️ View</button>
                                            <button class="small-btn">✏️ Edit</button>
                                            <button class="small-btn">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="leaderboardsSection" class="content-section hidden">
                <div class="section-header">
                    <h1 id="leaderboardTitle">🏆 CLAW MACHINE Leaderboard</h1>
                    <button class="btn btn-primary" onclick="toggleLeaderboardMode()" style="width: auto; padding: 12px 24px;">
                        <span id="toggleModeText">Switch to OPEN WORLD</span>
                    </button>
                </div>

                <div style="margin-bottom: 24px;">
                    <h3 style="margin-bottom: 12px; color: #323f90;">Filter by Math Operation:</h3>
                    <div id="filterButtons" style="display: flex; flex-wrap: wrap; gap: 12px;">
                        <!-- Claw Machine Filters (default) -->
                        <button class="small-btn filter-btn active" onclick="filterLeaderboard('')">All</button>
                        <button class="small-btn filter-btn" onclick="filterLeaderboard('Addition')">Addition</button>
                        <button class="small-btn filter-btn" onclick="filterLeaderboard('Subtraction')">Subtraction</button>
                        <button class="small-btn filter-btn" onclick="filterLeaderboard('Multiplication')">Multiplication</button>
                        <button class="small-btn filter-btn" onclick="filterLeaderboard('Division')">Division</button>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;" id="leaderboardContainer">
                    <!-- Top 10 will be generated dynamically -->
                </div>
            </section>

            <section id="aboutSection" class="content-section hidden">
                <div class="section-header">
                    <h1>ℹ️ About Mathemahika</h1>
                </div>

                <div style="display: grid; gap: 32px;">
                    <!-- System Overview -->
                    <div class="table-card">
                        <h3 class="subheading">🎯 System Overview</h3>
                        <div class="tag">📚 Educational Math Platform</div>
                        <div style="margin-top: 16px; line-height: 1.6; color: #4a5568;">
                            <p><strong>Mathemahika</strong> is a comprehensive educational platform designed to enhance mathematics learning through interactive games, quizzes, and performance tracking. Our system combines gamification with educational content to make learning math engaging and effective.</p>
                        </div>
                    </div>

                    <!-- Key Features -->
                    <div class="table-card">
                        <h3 class="subheading">✨ Key Features</h3>
                        <div class="tag">🚀 Platform Capabilities</div>
                        <div style="margin-top: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                                <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                    <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">🎮 Interactive Games</h4>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">Focused Claw Machine scenes tied to Firebase quiz types (e.g., Addition → claw_addition) and Open World mixed-operation adventures.</p>
                                </div>
                                <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                    <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">🧠 Custom Quizzes</h4>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">Create and manage quizzes with customizable questions and scoring</p>
                                </div>
                                <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                    <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">🏆 Leaderboards</h4>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">Track top performers across different game modes and operations</p>
                                </div>
                                <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                    <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">📊 Data Report</h4>
                                    <p style="margin: 0; font-size: 14px; color: #4a5568;">Comprehensive performance tracking and student management</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Game Modes -->
                    <div class="table-card">
                        <h3 class="subheading">🎮 Game Modes</h3>
                        <div class="tag">🎯 Learning Approaches</div>
                        <div style="margin-top: 16px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 18px;">🎮 Claw Machine</h4>
                                    <p style="margin: 0 0 12px 0; opacity: 0.9;">Scene-specific quizzes pulled by Firebase type (set quiz type to claw_addition, claw_subtraction, claw_multiplication, or claw_division).</p>
                                    <ul style="margin: 0; padding-left: 16px; opacity: 0.9;">
                                        <li>Addition → claw_addition</li>
                                        <li>Subtraction → claw_subtraction</li>
                                        <li>Multiplication → claw_multiplication</li>
                                        <li>Division → claw_division</li>
                                    </ul>
                                </div>
                                <div style="padding: 20px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white;">
                                    <h4 style="margin: 0 0 12px 0; font-size: 18px;">🌍 Open World</h4>
                                    <p style="margin: 0 0 12px 0; opacity: 0.9;">Mixed operations for comprehensive practice</p>
                                    <ul style="margin: 0; padding-left: 16px; opacity: 0.9;">
                                        <li>Combined operations</li>
                                        <li>Advanced problem solving</li>
                                        <li>Adaptive difficulty</li>
                                        <li>Mixed math challenges</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Technology Stack -->
                    <div class="table-card">
                        <h3 class="subheading">⚙️ Technology Stack</h3>
                        <div class="tag">🛠️ Built With Modern Technologies</div>
                        <div style="margin-top: 16px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🔥</div>
                                    <strong>Firebase</strong><br>
                                    <small style="color: #6c7aa0;">Backend & Database</small>
                                </div>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🌐</div>
                                    <strong>Web Technologies</strong><br>
                                    <small style="color: #6c7aa0;">HTML5, CSS3, JavaScript</small>
                                </div>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">🎮</div>
                                    <strong>Unity Integration</strong><br>
                                    <small style="color: #6c7aa0;">Game Development</small>
                                </div>
                                <div style="padding: 12px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 8px;">📱</div>
                                    <strong>Responsive Design</strong><br>
                                    <small style="color: #6c7aa0;">Cross-Platform Support</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Development Team -->
                    <div class="table-card">
                        <h3 class="subheading">👥 Development Team</h3>
                        <div class="tag">🎓 STI College Caloocan</div>
                        <div style="margin-top: 16px;">
                            <div style="display: grid; gap: 16px;">
                                <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; color: white; text-align: center;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 20px;">👑 John Andrei Benosa</h4>
                                    <p style="margin: 0; opacity: 0.9; font-size: 16px;">Group Leader & Web Developer</p>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                    <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                        <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">🎮 Brian Pizarro</h4>
                                        <p style="margin: 0; font-size: 14px; color: #4a5568;">Game Developer & Backend Web</p>
                                    </div>
                                    
                                    <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                        <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">💻 Jasper Mercado</h4>
                                        <p style="margin: 0; font-size: 14px; color: #4a5568;">Web Developer</p>
                                    </div>
                                    
                                    <div style="padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1); text-align: center;">
                                        <h4 style="margin: 0 0 8px 0; color: #323f90; font-size: 16px;">🌍 Jake Vergara</h4>
                                        <p style="margin: 0; font-size: 14px; color: #4a5568;">Open World Development</p>
                                    </div>
                                </div>
                                
                                <div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; border: 1px solid rgba(16, 185, 129, 0.2); text-align: center;">
                                    <h4 style="margin: 0 0 8px 0; color: #059669; font-size: 18px;">🏫 STI College Caloocan</h4>
                                    <p style="margin: 0; font-size: 14px; color: #047857;">Educational Institution</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact & Support -->
                    <div class="table-card">
                        <h3 class="subheading">📞 Contact & Support</h3>
                        <div class="tag">🤝 Get Help</div>
                        <div style="margin-top: 16px; line-height: 1.6; color: #4a5568;">
                            <p>For technical support, feature requests, or general inquiries about the Mathemahika platform, please contact the system administrator.</p>
                            <div style="margin-top: 16px; padding: 16px; background: rgba(102, 126, 234, 0.08); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                <strong style="color: #323f90;">System Version:</strong> 1.0.0<br>
                                <strong style="color: #323f90;">Last Updated:</strong> <span id="lastUpdatedDate"></span><br>
                                <strong style="color: #323f90;">Platform Status:</strong> <span style="color: #10b981;">🟢 Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="reportsSection" class="content-section hidden">
                <div class="table-card" style="gap: 24px;">
                    <div class="section-header" style="margin-bottom: 0;">
                        <div>
                            <h1 style="font-size: 26px; margin-bottom: 6px;">📊 Data Report</h1>
                            <small style="color: #6c7aa0;">Overview of students, quizzes, and engagement metrics</small>
                    </div>
                        <button class="btn btn-primary" id="refreshReportBtn" style="width: auto; padding: 12px 24px;">
                            🔄 Refresh Data
                        </button>
                    </div>

                    <div class="cards-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                        <div class="dash-card" style="background: rgba(102, 126, 234, 0.12); border: none;">
                            <h3>Total Registered Students</h3>
                            <strong id="reportTotalStudents">0</strong>
                            <small style="color: #6c7aa0; font-weight: 600;">Including active and inactive accounts</small>
                        </div>
                        <div class="dash-card" style="background: rgba(16, 185, 129, 0.12); border: none;">
                            <h3>Students With Quiz Attempts</h3>
                            <strong id="reportActiveStudents">0</strong>
                            <small style="color: #047857; font-weight: 600;">Students who submitted at least one quiz</small>
                        </div>
                        <div class="dash-card" style="background: rgba(249, 115, 22, 0.12); border: none;">
                            <h3>Total Quizzes</h3>
                            <strong id="reportTotalQuizzes">0</strong>
                            <small style="color: #ea580c; font-weight: 600;">Published and draft quizzes</small>
                        </div>
                        <div class="dash-card" style="background: rgba(236, 72, 153, 0.12); border: none;">
                            <h3>Total Quiz Attempts</h3>
                            <strong id="reportTotalAttempts">0</strong>
                            <small style="color: #db2777; font-weight: 600;">Across all quiz types and operations</small>
                        </div>
                        <div class="dash-card" style="background: rgba(34, 197, 94, 0.12); border: none;">
                            <h3>Average Score</h3>
                            <strong id="reportAverageScore">0</strong>
                            <small style="color: #15803d; font-weight: 600;">Overall class performance</small>
                        </div>
                        <div class="dash-card" style="background: rgba(168, 85, 247, 0.12); border: none;">
                            <h3>Success Rate</h3>
                            <strong id="reportSuccessRate">0%</strong>
                            <small style="color: #7c3aed; font-weight: 600;">Students scoring 70% or higher</small>
                        </div>
                        <div class="dash-card" style="background: rgba(59, 130, 246, 0.12); border: none;">
                            <h3>Most Popular Operation</h3>
                            <strong id="reportPopularOperation">—</strong>
                            <small style="color: #2563eb; font-weight: 600;">Most attempted quiz type</small>
                        </div>
                        <div class="dash-card" style="background: rgba(245, 158, 11, 0.12); border: none;">
                            <h3>Average Time per Quiz</h3>
                            <strong id="reportAvgTime">0s</strong>
                            <small style="color: #d97706; font-weight: 600;">Time taken to complete quizzes</small>
                        </div>
                    </div>

                    <div class="table-card" style="background: white; border: 1px solid rgba(102, 126, 234, 0.15);">
                        <h3 class="subheading">Quiz Performance Summary</h3>
                        <div style="overflow-x: auto;">
                            <table style="min-width: 640px;">
                                <thead>
                                    <tr>
                                        <th>Quiz Name</th>
                                        <th>Type</th>
                                        <th>Attempts</th>
                                        <th>Average Score</th>
                                        <th>Top Score</th>
                                        <th>Last Attempt</th>
                                    </tr>
                                </thead>
                                <tbody id="reportQuizSummaryBody">
                                    <tr>
                                        <td colspan="7" style="text-align: center; padding: 24px; color: #6c7aa0;">
                                            No quiz data available. Click refresh to load report.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-card" style="background: white; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h3 class="subheading">Most Active Students</h3>
                        <div style="overflow-x: auto;">
                            <table style="min-width: 580px;">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Total Attempts</th>
                                        <th>Average Score</th>
                                        <th>Best Operation</th>
                                        <th>Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody id="reportActiveStudentsBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; padding: 24px; color: #6c7aa0;">
                                            No activity data yet. Recent quiz attempts will appear here.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="table-card" style="background: white; border: 1px solid rgba(102, 126, 234, 0.15);">
                        <h3 class="subheading">📈 Performance Insights</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 16px;">
                            <div style="padding: 16px; background: rgba(34, 197, 94, 0.08); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.2);">
                                <h4 style="margin: 0 0 8px 0; color: #15803d; font-size: 16px;">🎯 Top Performers</h4>
                                <div id="topPerformersList" style="color: #4a5568; font-size: 14px;">
                                    <div style="padding: 8px 0; border-bottom: 1px solid rgba(34, 197, 94, 0.1);">
                                        <span style="font-weight: 600;">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 16px; background: rgba(59, 130, 246, 0.08); border-radius: 12px; border: 1px solid rgba(59, 130, 246, 0.2);">
                                <h4 style="margin: 0 0 8px 0; color: #2563eb; font-size: 16px;">📊 Operation Breakdown</h4>
                                <div id="operationBreakdown" style="color: #4a5568; font-size: 14px;">
                                    <div style="padding: 8px 0; border-bottom: 1px solid rgba(59, 130, 246, 0.1);">
                                        <span style="font-weight: 600;">Loading...</span>
                                    </div>
                                </div>
                            </div>
                            <div style="padding: 16px; background: rgba(168, 85, 247, 0.08); border-radius: 12px; border: 1px solid rgba(168, 85, 247, 0.2);">
                                <h4 style="margin: 0 0 8px 0; color: #7c3aed; font-size: 16px;">⏱️ Time Analysis</h4>
                                <div id="timeAnalysis" style="color: #4a5568; font-size: 14px;">
                                    <div style="padding: 8px 0; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
                                        <span style="font-weight: 600;">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-card" style="background: #f8f9fe; border: 1px solid rgba(102, 126, 234, 0.15);">
                        <h3 class="subheading">Report Notes</h3>
                        <ul style="margin-left: 18px; color: #4a5568; line-height: 1.7;">
                            <li>Data is sourced from Realtime Database `/users`, `/quizzes`, and `/quizResults` nodes.</li>
                            <li>Use the refresh button to recompute metrics after adding new quizzes or quiz attempts.</li>
                            <li>Custom export (CSV/PDF) can be added based on school requirements.</li>
                            <li>Ensure database rules allow read access for aggregated report data.</li>
                        </ul>
                    </div>
                </div>
            </section>

            <section id="downloadSection" class="content-section hidden">
                <div class="table-card" style="gap: 24px;">
                    <div class="section-header" style="margin-bottom: 0;">
                        <div>
                            <h1 style="font-size: 26px; margin-bottom: 6px;">📱 Download MatheMahika App</h1>
                            <small style="color: #6c7aa0;">Get the mobile app for students to play math games and take quizzes</small>
                        </div>
                    </div>

                    <!-- App Information -->
                    <div class="table-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 80px; margin-bottom: 16px;">🎮</div>
                                <h2 style="margin: 0; font-size: 24px;">MatheMahika</h2>
                                <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 16px;">Math Learning Game</p>
                            </div>
                            <div>
                                <h3 style="margin: 0 0 16px 0; font-size: 20px;">Interactive Math Learning</h3>
                                <p style="margin: 0 0 16px 0; opacity: 0.9; line-height: 1.6;">
                                    Students can play engaging math games, take quizzes, and track their progress. 
                                    The app syncs with this admin dashboard for real-time monitoring.
                                </p>
                                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                    <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                        🎯 Claw Machine Games
                                    </span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                        🌍 Open World Adventures
                                    </span>
                                    <span style="background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px; font-size: 14px;">
                                        📊 Progress Tracking
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Download Options -->
                    <div class="cards-grid" style="grid-template-columns: 1fr; max-width: 400px; margin: 0 auto;">
                        <div class="table-card" style="background: white; border: 2px solid rgba(34, 197, 94, 0.2);">
                            <div style="text-align: center; padding: 30px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">📱</div>
                                <h3 style="margin: 0 0 16px 0; color: #15803d; font-size: 24px;">Android App</h3>
                                <p style="margin: 0 0 24px 0; color: #6c7aa0; font-size: 16px; line-height: 1.5;">
                                    Download the MatheMahika Android APK file for mobile devices
                                </p>
                                <button class="btn btn-primary" onclick="downloadAPK()" style="width: 100%; margin-bottom: 16px; padding: 16px; font-size: 16px;">
                                    📥 Download APK
                                </button>
                                <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px;">
                                    <small style="color: #15803d; font-weight: 600; display: block; margin-bottom: 4px;">
                                        Version 1.0.0 • Size: ~200MB
                                    </small>
                                    <small style="color: #6c7aa0; font-size: 13px;">
                                        Requires Android 7.0+ • 6-8GB RAM recommended
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Installation Instructions -->
                    <div class="table-card" style="background: #f8f9fe; border: 1px solid rgba(102, 126, 234, 0.15);">
                        <h3 class="subheading">📋 Android Installation Instructions</h3>
                        <div style="max-width: 600px; margin: 0 auto;">
                            <div style="padding: 24px; background: white; border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.1);">
                                <h4 style="margin: 0 0 16px 0; color: #15803d; font-size: 18px; text-align: center;">📱 How to Install MatheMahika on Android</h4>
                                <ol style="margin: 0; padding-left: 24px; color: #4a5568; line-height: 1.8; font-size: 15px;">
                                    <li><strong>Check Device Requirements:</strong> Ensure your Android device has Android 7.0 or higher and at least 6-8GB RAM for optimal performance</li>
                                    <li><strong>Download the APK:</strong> Click the "Download APK" button above to download the ~200MB file</li>
                                    <li><strong>Enable Unknown Sources:</strong> Go to Settings → Security → Enable "Install from Unknown Sources" or "Allow from this source"</li>
                                    <li><strong>Install the App:</strong> Tap the downloaded APK file in your Downloads folder</li>
                                    <li><strong>Follow Prompts:</strong> Follow the installation prompts and grant necessary permissions</li>
                                    <li><strong>Launch & Login:</strong> Open MatheMahika, create a student account or login, and start learning!</li>
                                </ol>
                                <div style="background: rgba(34, 197, 94, 0.1); padding: 16px; border-radius: 8px; margin-top: 20px; text-align: center;">
                                    <p style="margin: 0; color: #15803d; font-weight: 600; font-size: 14px;">
                                        💡 Tip: Make sure you have a stable internet connection for the best experience!
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- System Requirements -->
                    <div class="table-card" style="background: white; border: 1px solid rgba(102, 126, 234, 0.15);">
                        <h3 class="subheading">⚙️ Android System Requirements</h3>
                        <div style="max-width: 500px; margin: 0 auto;">
                            <div style="padding: 20px; background: rgba(34, 197, 94, 0.08); border-radius: 12px; border: 1px solid rgba(34, 197, 94, 0.1);">
                                <h4 style="margin: 0 0 16px 0; color: #15803d; font-size: 18px; text-align: center;">📱 Required Specifications</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div>
                                        <h5 style="margin: 0 0 8px 0; color: #15803d; font-size: 14px;">Operating System</h5>
                                        <p style="margin: 0; color: #4a5568; font-size: 14px;">Android 7.0 or higher</p>
                                    </div>
                                    <div>
                                        <h5 style="margin: 0 0 8px 0; color: #15803d; font-size: 14px;">RAM</h5>
                                        <p style="margin: 0; color: #4a5568; font-size: 14px;">6-8GB recommended</p>
                                    </div>
                                    <div>
                                        <h5 style="margin: 0 0 8px 0; color: #15803d; font-size: 14px;">Storage</h5>
                                        <p style="margin: 0; color: #4a5568; font-size: 14px;">200MB free space</p>
                                    </div>
                                    <div>
                                        <h5 style="margin: 0 0 8px 0; color: #15803d; font-size: 14px;">Network</h5>
                                        <p style="margin: 0; color: #4a5568; font-size: 14px;">Stable internet connection</p>
                                    </div>
                                </div>
                                <div style="background: rgba(34, 197, 94, 0.1); padding: 12px; border-radius: 8px; margin-top: 16px; text-align: center;">
                                    <p style="margin: 0; color: #15803d; font-weight: 600; font-size: 13px;">
                                        ⚠️ Note: MatheMahika is only available for Android devices
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- QR Code for Easy Access -->
                    <div class="table-card" style="background: white; border: 1px solid rgba(102, 126, 234, 0.15); text-align: center;">
                        <h3 class="subheading">📱 Quick Download QR Code</h3>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 24px; margin-top: 16px; flex-wrap: wrap;">
                            <div style="padding: 20px; background: white; border: 2px solid rgba(34, 197, 94, 0.2); border-radius: 12px;">
                                <div style="width: 120px; height: 120px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 48px;">
                                    📱
                                </div>
                                <p style="margin: 12px 0 0 0; font-size: 14px; color: #15803d; font-weight: 600;">Scan to download APK</p>
                            </div>
                            <div style="text-align: left; max-width: 300px;">
                                <h4 style="margin: 0 0 8px 0; color: #323f90;">Easy Android Download</h4>
                                <p style="margin: 0; color: #4a5568; font-size: 14px; line-height: 1.5;">
                                    Students can scan this QR code with their Android phone camera to quickly download the MatheMahika APK file directly to their device.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="accountSection" class="content-section hidden">
                <div class="split-layout">
                    <div class="table-card">
                        <h3 class="subheading">Register Student</h3>
                        <form id="registrationForm">
                            <div class="form-group">
                                <label for="username">Username:</label>
                                <input type="text" id="username" name="username" required 
                                       placeholder="Enter username" minlength="3" maxlength="20" oninput="updateEmailPreview()">
                            </div>
                            
                            <div class="form-group">
                                <label for="fullName">Full Name:</label>
                                <input type="text" id="fullName" name="fullName" required 
                                       placeholder="Enter full name">
                            </div>
                            
                            <div class="form-group">
                                <label for="email">Email:</label>
                                <input type="email" id="email" name="email" required 
                                       placeholder="Auto-generated: username@mathemahika.com" readonly
                                       style="background-color: #f8f9fa; color: #6c7aa0;">
                                <small style="color: #6c7aa0; font-size: 12px; margin-top: 4px; display: block;">
                                    Email will be auto-generated as: [username]@mathemahika.com
                                </small>
                            </div>
                            
                            <div class="form-group">
                                <label for="password">Password:</label>
                                <input type="password" id="password" name="password" required 
                                       placeholder="Enter password" minlength="6">
                            </div>
                            
                            <div class="form-group">
                                <label for="confirmPassword">Confirm Password:</label>
                                <input type="password" id="confirmPassword" name="confirmPassword" required 
                                       placeholder="Confirm password">
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                Create Account
                            </button>
                            
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                Reset Form
                            </button>
                        </form>

                        <div id="message" class="message" style="display: none;"></div>
                    </div>

                    <div class="table-card table-card--list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div>
                                <h3 class="subheading" style="margin-bottom: 8px;">Recently Created Accounts</h3>
                                <div class="tag">📅 All Registrations (Newest First)</div>
                            </div>
                            <button id="deleteSelectedBtn" class="btn btn-primary" style="width: auto; padding: 10px 20px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); display: none;" onclick="deleteSelectedAccounts()">
                                🗑️ Delete Selected (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="position: relative; max-width: 400px;">
                                <input 
                                    type="text" 
                                    id="userSearchInput" 
                                    placeholder="🔍 Search by name, username, or email..." 
                                    onkeyup="searchUsers()"
                                    style="width: 100%; padding: 12px 40px 12px 16px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 14px; transition: border-color 0.3s ease; outline: none;"
                                    onfocus="this.style.borderColor='#667eea'"
                                    onblur="this.style.borderColor='#e1e5e9'"
                                >
                                <button 
                                    onclick="clearSearch()" 
                                    id="clearSearchBtn"
                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px; color: #9ca3af; padding: 4px 8px; display: none;"
                                    title="Clear search"
                                >✕</button>
                            </div>
                            <div id="searchResults" style="margin-top: 8px; font-size: 13px; color: #6c7aa0;"></div>
                        </div>
                        
                        <div style="max-height: 500px; overflow-y: auto; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                            <table>
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllAccounts" onchange="toggleSelectAll(this)" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </th>
                                    <th>Full Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Created Date</th>
                                    <th>Status</th>
                                    <th style="width: 180px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recentAccountsTableBody">
                                <tr>
                                    <td>
                                        <input type="checkbox" class="account-checkbox" data-account-id="1" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </td>
                                    <td>Juan Dela Cruz</td>
                                    <td>juan_dc</td>
                                    <td>juan@math.com</td>
                                    <td>Oct 13, 2025</td>
                                    <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn" onclick="editAccountDetails(1)">✏️ Edit</button>
                                            <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount(1)">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="account-checkbox" data-account-id="2" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </td>
                                    <td>Maria Santos</td>
                                    <td>maria_s</td>
                                    <td>maria@math.com</td>
                                    <td>Oct 12, 2025</td>
                                    <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn" onclick="editAccountDetails(2)">✏️ Edit</button>
                                            <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount(2)">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="account-checkbox" data-account-id="3" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </td>
                                    <td>Carlos Reyes</td>
                                    <td>carlos_r</td>
                                    <td>carlos@math.com</td>
                                    <td>Oct 11, 2025</td>
                                    <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn" onclick="editAccountDetails(3)">✏️ Edit</button>
                                            <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount(3)">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="account-checkbox" data-account-id="4" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </td>
                                    <td>Ana Lopez</td>
                                    <td>ana_lopez</td>
                                    <td>ana@math.com</td>
                                    <td>Oct 10, 2025</td>
                                    <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn" onclick="editAccountDetails(4)">✏️ Edit</button>
                                            <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount(4)">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <input type="checkbox" class="account-checkbox" data-account-id="5" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                                    </td>
                                    <td>Pedro Garcia</td>
                                    <td>pedro_g</td>
                                    <td>pedro@math.com</td>
                                    <td>Oct 9, 2025</td>
                                    <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                                    <td>
                                        <div class="user-row-actions">
                                            <button class="small-btn" onclick="editAccountDetails(5)">✏️ Edit</button>
                                            <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount(5)">🗑️ Delete</button>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </div>

                <div class="split-layout" style="margin-top: 24px;">
                    <div class="table-card">
                        <h3 class="subheading">Admin Profile</h3>
                        <p style="margin-bottom: 12px; color: #6c7aa0;">Securely update your admin password.</p>
                        <form id="passwordUpdateForm">
                            <div class="form-group">
                                <label for="newAdminPassword">New Admin Password:</label>
                                <input type="password" id="newAdminPassword" name="newAdminPassword" placeholder="Enter new admin password" minlength="6">
                            </div>
                            <button type="button" class="btn btn-primary" id="updatePasswordBtn">
                                Update Password
                            </button>
                        </form>
                        <div id="accountMessage" class="message" style="display: none;"></div>
                    </div>

                    <div class="table-card">
                        <h3 class="subheading">Admins</h3>
                        <div class="tag">👥 Admin Credentials</div>
                        <div style="margin-top: 16px;">
                            <div style="padding: 16px; background-color: rgba(102, 126, 234, 0.08); border-radius: 12px; margin-bottom: 12px;">
                                <p style="font-weight: 600; color: #323f90; margin-bottom: 8px; font-size: 15px;">Primary Admin</p>
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 13px; color: #6c7aa0; font-weight: 600;">Username:</span>
                                        <span id="adminUsernameDisplay" style="font-size: 13px; color: #323f90; font-family: monospace; background-color: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 4px;">admin</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span style="font-size: 13px; color: #6c7aa0; font-weight: 600;">Password:</span>
                                        <span id="adminPasswordDisplay" style="font-size: 13px; color: #323f90; font-family: monospace; background-color: rgba(255,255,255,0.8); padding: 2px 8px; border-radius: 4px;">••••••</span>
                                        <button onclick="togglePasswordVisibility()" style="background: none; border: none; cursor: pointer; font-size: 16px; padding: 2px 6px;" title="Toggle password visibility">👁️</button>
                                    </div>
                                </div>
                                <p style="font-size: 12px; color: #9ca3af; margin-top: 8px;">Initialized: System Default</p>
                            </div>
                            <div style="padding: 12px; background-color: rgba(239, 68, 68, 0.08); border-radius: 12px; border: 1px solid rgba(239, 68, 68, 0.2);">
                                <p style="font-size: 12px; color: #dc2626; font-weight: 600; margin-bottom: 4px;">⚠️ Security Notice</p>
                                <p style="font-size: 11px; color: #dc2626;">Please update the default admin password immediately for security.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
        import { getDatabase, ref, set, get, push, query, orderByChild, equalTo } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';
        import { firebaseConfig } from './firebase-config.js';
        import { adminConfig } from './admin-config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Admin credentials (update password as needed)
        const { username: ADMIN_USERNAME, password: ADMIN_PASSWORD } = adminConfig;

        let adminAuthenticated = false;
        let connectionIntervalId = null;

        // Terms and Conditions Modal Functions
        window.openTermsModal = function() {
            const modal = document.getElementById('termsModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        window.closeTermsModal = function() {
            const modal = document.getElementById('termsModal');
            modal.classList.remove('active');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Close modal when clicking outside the modal content
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('termsModal');
            if (event.target === modal) {
                closeTermsModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const termsModal = document.getElementById('termsModal');
                const editPasswordModal = document.getElementById('editPasswordModal');
                const addQuizModal = document.getElementById('addQuizModal');
                
                if (termsModal.classList.contains('active')) {
                    closeTermsModal();
                }
                if (editPasswordModal.classList.contains('active')) {
                    closeEditPasswordModal();
                }
                if (addQuizModal.classList.contains('active')) {
                    closeAddQuizModal();
                }
                const viewQuizModal = document.getElementById('viewQuizModal');
                if (viewQuizModal && viewQuizModal.classList.contains('active')) {
                    closeViewQuizModal();
                }
                const studentViewModal = document.getElementById('studentViewModal');
                if (studentViewModal && studentViewModal.classList.contains('active')) {
                    closeStudentViewModal();
                }
                
                const editQuizModal = document.getElementById('editQuizModal');
                if (editQuizModal && editQuizModal.classList.contains('active')) {
                    closeEditQuizModal();
                }
            }
        });

        // Close edit password modal when clicking outside
        document.addEventListener('click', function(event) {
            const editPasswordModal = document.getElementById('editPasswordModal');
            if (event.target === editPasswordModal) {
                closeEditPasswordModal();
            }
        });

        // Close add quiz modal when clicking outside
        document.addEventListener('click', function(event) {
            const addQuizModal = document.getElementById('addQuizModal');
            if (event.target === addQuizModal) {
                closeAddQuizModal();
            }
        });

        // Close view quiz modal when clicking outside
        document.addEventListener('click', function(event) {
            const viewQuizModal = document.getElementById('viewQuizModal');
            if (event.target === viewQuizModal) {
                closeViewQuizModal();
            }
        });

        // Close student view modal when clicking outside
        document.addEventListener('click', function(event) {
            const studentViewModal = document.getElementById('studentViewModal');
            if (event.target === studentViewModal) {
                closeStudentViewModal();
            }
        });

        // Close edit quiz modal when clicking outside
        document.addEventListener('click', function(event) {
            const editQuizModal = document.getElementById('editQuizModal');
            if (event.target === editQuizModal) {
                closeEditQuizModal();
            }
        });

        // Make Firebase available globally
        window.firebaseDatabase = database;
        window.ref = ref;
        window.set = set;
        window.get = get;

        // Sanitize database path to avoid "Invalid token in path" errors
        function sanitizePath(path) {
            return path.replace(/[.$#\[\]/]/g, '_');
        }

        // Check database connection status
        async function checkDatabaseConnection() {
            if (!adminAuthenticated) {
                return false;
            }
            try {
                console.log('Checking Firebase connection...');
                const testRef = ref(database, 'users');
                await get(testRef);
                updateConnectionStatus(true);
                return true;
            } catch (error) {
                console.log(error);
                console.error('Database connection check failed:', error);
                updateConnectionStatus(false);
                return false;
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(isConnected) {
            const statusIndicator = document.getElementById('connectionStatus');
            if (statusIndicator) {
                if (isConnected) {
                    statusIndicator.innerHTML = '🟢 Connected';
                    statusIndicator.className = 'connection-status connected';
                } else {
                    statusIndicator.innerHTML = '🔴 Disconnected';
                    statusIndicator.className = 'connection-status disconnected';
                }
            }
        }

        // Show message
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        function showLoginMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
        }

        function updateSidebarState(sectionId) {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.content-section');

            // Update navigation items
            navItems.forEach(item => {
                const target = item.getAttribute('data-section');
                if (target === sectionId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Update content sections with smooth transition
            sections.forEach(section => {
                const id = section.getAttribute('id');
                const mappedId = `${sectionId}Section`;
                
                if (id === mappedId) {
                    // Show the target section
                    section.style.display = 'flex';
                    section.classList.remove('hidden');
                    
                    // Force reflow to ensure the element is visible before transition
                    section.offsetHeight;
                    
                    // Add a small delay to ensure smooth transition
                    setTimeout(() => {
                        section.style.opacity = '1';
                        section.style.transform = 'translateX(0)';
                    }, 10);
                } else {
                    // Hide other sections
                    section.style.opacity = '0';
                    section.style.transform = 'translateX(20px)';
                    
                    setTimeout(() => {
                        section.classList.add('hidden');
                        section.style.display = 'none';
                    }, 300);
                }
            });

            if (sectionId === 'reports') {
            lastReportLoadPromise = loadDataReport(true);
            }

            // Store current section in localStorage for persistence
            localStorage.setItem('currentSection', sectionId);
        }

        function handleAdminLogin(e) {
            e.preventDefault();

            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value;
            const termsCheckbox = document.getElementById('adminTermsCheckbox');

            // Check if terms and conditions are accepted
            if (!termsCheckbox.checked) {
                showLoginMessage('Please accept the Terms and Conditions to continue.', 'error');
                return;
            }

            if (username.toLowerCase() !== ADMIN_USERNAME.toLowerCase()) {
                showLoginMessage('Invalid username. Please try again.', 'error');
                return;
            }

            if (password !== ADMIN_PASSWORD) {
                showLoginMessage('Invalid password. Please try again.', 'error');
                return;
            }

            adminAuthenticated = true;
            showLoginMessage('Authentication successful! Redirecting...', 'success');

            const connectionStatus = document.getElementById('connectionStatus');
            const loginContainer = document.getElementById('adminLoginContainer');
            const registrationContainer = document.getElementById('registrationContainer');

            setTimeout(() => {
                loginContainer.classList.add('hidden');
                registrationContainer.classList.remove('hidden');
                connectionStatus.classList.remove('hidden');
                
                // Initialize with saved section or default to dashboard
                const savedSection = localStorage.getItem('currentSection') || 'dashboard';
                updateSidebarState(savedSection);
                
                // Load recently created accounts from Firebase
                loadRecentlyCreatedAccounts();
                
                // Load all students for Students tab
                loadAllStudents();
                
                // Load leaderboard data
                loadLeaderboard();
                
                // Load quizzes
                loadQuizzes();
                
                checkDatabaseConnection();
                if (connectionIntervalId) {
                    clearInterval(connectionIntervalId);
                }
                connectionIntervalId = setInterval(checkDatabaseConnection, 30000);
            }, 600);
        }

        // Handle registration form submission
        async function handleRegistration(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const fullname = document.getElementById('fullName').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            // Auto-generate email based on username
            const email = `${username}@mathemahika.com`;
            
            // Validation
            if (password !== confirmPassword) {
                showMessage('Passwords do not match!', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('Password must be at least 6 characters long!', 'error');
                return;
            }
            
            // Check database connection
            const isConnected = await checkDatabaseConnection();
            if (!isConnected) {
                showMessage('Cannot create account: Database connection is not available. Please check your internet connection and try again.', 'error');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<span class="loading"></span>Creating Account...';
            submitBtn.disabled = true;
            
            try {
                // Enforce unique username
                const usernameQuery = query(ref(database, 'users'), orderByChild('username'), equalTo(username));
                const usernameSnapshot = await get(usernameQuery);
                if (usernameSnapshot.exists()) {
                    showMessage('Username is already taken. Please choose another.', 'error');
                    return;
                }
                
                // Prepare user data
                const userData = {
                    username: username,
                    fullname: fullname,
                    email: email,
                    score: 0,
                    CWHighScore: 0,
                    OPHighScore: 0,
                    createdAt: new Date().toISOString(),
                    lastLogin: new Date().toISOString(),
                    isAdmin: false,
                    password: password,
                    passwordUpdatedAt: new Date().toISOString()
                };
                
                // Save user data to Firebase Database
                const newUserRef = push(ref(database, 'users'));
                await set(newUserRef, userData);
                
                showMessage('Account created successfully! Welcome to MatheMahika!', 'success');
                
                // Refresh the recently created accounts table
                loadRecentlyCreatedAccounts();
                
                // Refresh the all students table
                loadAllStudents();
                
                // Reset form after success
                setTimeout(() => {
                    resetForm();
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                let errorMessage = 'Failed to create : ';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage += 'Email is already registered.';
                        break;
                    case 'auth/weak-password':
                        errorMessage += 'Password is too weak.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Invalid email address.';
                        break;
                    case 'auth/network-request-failed':
                        errorMessage += 'Network error. Please check your internet connection.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage += 'Too many requests. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Reset form
        function resetForm() {
            document.getElementById('registrationForm').reset();
            document.getElementById('message').style.display = 'none';
        }

        // Account management functions
        window.toggleSelectAll = function(checkbox) {
            const checkboxes = document.querySelectorAll('.account-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteButton();
        }

        window.updateDeleteButton = function() {
            const checkboxes = document.querySelectorAll('.account-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const countSpan = document.getElementById('selectedCount');
            
            if (checkboxes.length > 0) {
                deleteBtn.style.display = 'block';
                countSpan.textContent = checkboxes.length;
            } else {
                deleteBtn.style.display = 'none';
                countSpan.textContent = '0';
            }

            // Update "Select All" checkbox state
            const allCheckboxes = document.querySelectorAll('.account-checkbox');
            const selectAllCheckbox = document.getElementById('selectAllAccounts');
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
            }
        }

        window.deleteSelectedAccounts = async function() {
            const checkboxes = document.querySelectorAll('.account-checkbox:checked');
            const accountIds = Array.from(checkboxes).map(cb => cb.getAttribute('data-account-id'));
            
            if (accountIds.length === 0) return;

            const confirmMsg = `Are you sure you want to delete ${accountIds.length} selected account(s)? This action cannot be undone.`;
            if (confirm(confirmMsg)) {
                try {
                    // Delete all selected accounts from Firebase
                    const deletePromises = accountIds.map(async (accountId) => {
                        const userRef = ref(database, 'users/' + accountId);
                        await set(userRef, null);
                    });
                    
                    await Promise.all(deletePromises);

                    // Reset the select all checkbox and hide delete button
                    const selectAllCheckbox = document.getElementById('selectAllAccounts');
                    if (selectAllCheckbox) selectAllCheckbox.checked = false;
                    
                    // Refresh the tables
                    loadRecentlyCreatedAccounts();
                    loadAllStudents();
                    updateDeleteButton();

                    // Show success message
                    alert(`Successfully deleted ${accountIds.length} account(s) from Firebase`);
                } catch (error) {
                    console.error('Error deleting accounts:', error);
                    alert('Failed to delete some accounts. Please try again.');
                }
            }
        }

        window.deleteAccount = async function(accountId) {
            const confirmMsg = 'Are you sure you want to delete this account? This action cannot be undone.';
            if (confirm(confirmMsg)) {
                try {
                    // Delete from Firebase Database
                    const userRef = ref(database, 'users/' + accountId);
                    await set(userRef, null); // Setting to null deletes the entry
                    
                    // Refresh the tables
                    loadRecentlyCreatedAccounts();
                    loadAllStudents();
                    updateDeleteButton();
                    alert('Account deleted successfully from Firebase');
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account. Please try again.');
                }
            }
        }

        // Store current student being edited
        let currentEditingStudentId = null;

        window.editAccountDetails = function(accountId) {
            currentEditingStudentId = accountId;
            
            // Get student name from the table row
            const checkbox = document.querySelector(`.account-checkbox[data-account-id="${accountId}"]`);
            if (checkbox) {
                const row = checkbox.closest('tr');
                const nameCell = row.querySelector('td:nth-child(2)'); // Full Name column
                const studentName = nameCell ? nameCell.textContent : 'Student';
                
                // Update modal with student name
                document.getElementById('editStudentName').textContent = studentName;
            }
            
            // Reset form and open modal
            document.getElementById('editPasswordForm').reset();
            document.getElementById('editPasswordMessage').style.display = 'none';
            openEditPasswordModal();
        }

        window.openEditPasswordModal = function() {
            const modal = document.getElementById('editPasswordModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        window.closeEditPasswordModal = function() {
            const modal = document.getElementById('editPasswordModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            currentEditingStudentId = null;
        }

        window.saveNewPassword = function(event) {
            event.preventDefault();
            
            const newPassword = document.getElementById('newStudentPassword').value;
            const confirmPassword = document.getElementById('confirmStudentPassword').value;
            const messageDiv = document.getElementById('editPasswordMessage');
            
            // Validate passwords match
            if (newPassword !== confirmPassword) {
                messageDiv.textContent = 'Passwords do not match!';
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
                return;
            }
            
            // Validate password length
            if (newPassword.length < 6) {
                messageDiv.textContent = 'Password must be at least 6 characters long!';
                messageDiv.className = 'message error';
                messageDiv.style.display = 'block';
                return;
            }
            
            // Show loading state
            const saveBtn = document.getElementById('savePasswordBtn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            // Simulate API call (in production, this would update Firebase Auth and Database)
            setTimeout(() => {
                // Success
                messageDiv.textContent = 'Password updated successfully!';
                messageDiv.className = 'message success';
                messageDiv.style.display = 'block';
                
                // Reset button
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
                
                // Close modal after 1.5 seconds
                setTimeout(() => {
                    closeEditPasswordModal();
                    alert(`Password updated successfully for student ID: ${currentEditingStudentId}\n\nIn production, this would:\n- Update Firebase Authentication\n- Update student record in database\n- Send confirmation email to student`);
                }, 1500);
            }, 1000);
        }

        // Toggle password visibility
        let passwordVisible = false;
        window.togglePasswordVisibility = function() {
            const passwordDisplay = document.getElementById('adminPasswordDisplay');
            const toggleButton = event.target;
            
            if (passwordVisible) {
                passwordDisplay.textContent = '••••••';
                toggleButton.textContent = '👁️';
                toggleButton.title = 'Show password';
                passwordVisible = false;
            } else {
                passwordDisplay.textContent = ADMIN_PASSWORD;
                toggleButton.textContent = '🙈';
                toggleButton.title = 'Hide password';
                passwordVisible = true;
            }
        }

        // Quiz Management Functions
        const CLAW_MACHINE_OPERATIONS = {
            'claw_addition': 'addition',
            'claw_subtraction': 'subtraction',
            'claw_multiplication': 'multiplication',
            'claw_division': 'division'
        };

        const OPERATION_SYMBOLS = {
            'addition': '+',
            'subtraction': '-',
            'multiplication': '×',
            'division': '÷'
        };

        function isSpecificClawMachineType(type) {
            return !!CLAW_MACHINE_OPERATIONS[type];
        }

        function isClawMachineType(type) {
            return type === 'clawmachine' || isSpecificClawMachineType(type);
        }

        function getClawOperationFromType(type) {
            return CLAW_MACHINE_OPERATIONS[type] || '';
        }

        function getOperationSymbol(operation) {
            return OPERATION_SYMBOLS[operation] || '';
        }

        function formatQuizTypeLabel(type) {
            if (type === 'openworld') {
                return 'Open World';
            }
            if (type === 'clawmachine') {
                return 'Claw Machine';
            }
            if (isSpecificClawMachineType(type)) {
                const operation = getClawOperationFromType(type);
                return `Claw Machine - ${operation.charAt(0).toUpperCase()}${operation.slice(1)}`;
            }
            return type || 'Unknown';
        }

        function resolveOperationValue(quizType, selectedOperation) {
            if (quizType === 'openworld') {
                return 'mixed';
            }
            if (isSpecificClawMachineType(quizType)) {
                return getClawOperationFromType(quizType);
            }
            if (quizType === 'clawmachine') {
                return selectedOperation || 'mixed';
            }
            // Only default to 'mixed' if no operation is specified and it's not a specific type
            if (!selectedOperation && !quizType) {
                return 'mixed';
            }
            // Return the selected operation if available, otherwise return the quiz type
            return selectedOperation || quizType || 'mixed';
        }

        function getQuizResultsPath(quizId, quiz) {
            // Always use quizId as the primary path to ensure proper isolation
            // This prevents cross-contamination between different quizzes
            if (quizId) {
                return `quizManagement/${quizId}`;
            }

            // Fallback to resultsPath if quizId is not available
            if (quiz && quiz.resultsPath) {
                return `quizManagement/${quiz.resultsPath}`;
            }

            // For Unity results, we need to handle them differently
            // Unity results are stored under operation paths, but we should check quiz-specific paths first
            const operationKey = quiz && quiz.operation && quiz.operation !== 'mixed'
                ? quiz.operation.toLowerCase()
                : null;
            if (operationKey) {
                // For Unity results, we'll check both quiz-specific and operation-based paths
                // But prioritize quiz-specific paths
                return `quizManagement/${operationKey}`;
            }

            // Final fallback with unique identifier
            const fallbackId = quizId || Date.now().toString();
            return `quizManagement/fallback_${fallbackId}`;
        }

        async function fetchQuizResultsForQuiz(quizId, quiz) {
            try {
                const resultsPath = getQuizResultsPath(quizId, quiz);
                const resultsRef = ref(database, resultsPath);
                let snapshot = await get(resultsRef);

                // If no results found in quiz-specific path, try operation-based path
                if (!snapshot.exists() && quiz && quiz.operation) {
                    const operationPath = `quizManagement/${quiz.operation.toLowerCase()}`;
                    const operationRef = ref(database, operationPath);
                    snapshot = await get(operationRef);
                }

                if (!snapshot.exists()) {
                    return [];
                }

                const rows = [];
                snapshot.forEach(childSnapshot => {
                    const value = childSnapshot.val() || {};

                    if (value.quizId && value.quizId !== quizId) {
                        return;
                    }

                    // Handle nested structure where data might be in 'lastResult'
                    let resultData = value;
                    if (value.lastResult && typeof value.lastResult === 'object') {
                        resultData = value.lastResult;
                    }

                    const answered = Number.isFinite(resultData.answered) ? resultData.answered : ((Number(resultData.correct) || 0) + (Number(resultData.incorrect) || 0));
                    const correct = Number(resultData.correct) || 0;
                    const incorrect = Number(resultData.incorrect) || Math.max(0, answered - correct);

                    rows.push({
                        id: childSnapshot.key,
                        fullName: resultData.fullName || resultData.studentName || resultData.username || 'Unknown Student',
                        username: resultData.username || null,
                        score: Number(resultData.score) || 0,
                        correct,
                        incorrect,
                        answered,
                        timeSeconds: typeof resultData.timeSeconds === 'number' ? resultData.timeSeconds : (typeof resultData.timeTaken === 'number' ? resultData.timeTaken : null),
                        timestampUtc: resultData.timestampUtc || resultData.completedAt || resultData.finishedAt || '',
                        attemptsUsed: Number(value.attemptsUsed) || 1
                    });
                });

                rows.sort((a, b) => {
                    if (a.score !== b.score) {
                        return b.score - a.score;
                    }
                    if (a.timeSeconds != null && b.timeSeconds != null && a.timeSeconds !== b.timeSeconds) {
                        return a.timeSeconds - b.timeSeconds;
                    }
                    return (b.timestampUtc || '').localeCompare(a.timestampUtc || '');
                });

                return rows;
            } catch (error) {
                console.error('Failed to load quiz results:', error);
                return [];
            }
        }

        function formatDurationFromSeconds(seconds) {
            if (typeof seconds !== 'number' || !isFinite(seconds)) {
                return '—';
            }
            const totalSeconds = Math.max(0, Math.round(seconds));
            const minutes = Math.floor(totalSeconds / 60);
            const remainingSeconds = totalSeconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function computeQuestionCount(quiz) {
            if (!quiz) {
                return 0;
            }
            if (Number.isFinite(quiz.questionCount)) {
                return quiz.questionCount;
            }
            if (Array.isArray(quiz.questions)) {
                return quiz.questions.length;
            }
            return 0;
        }

        function formatOperationLabel(operation) {
            if (!operation) {
                return 'Mixed Fun';
            }

            const op = operation.toLowerCase();
            switch (op) {
                case 'addition':
                case 'claw_addition':
                    return 'Addition Adventure ➕';
                case 'subtraction':
                case 'claw_subtraction':
                    return 'Subtraction Mission ➖';
                case 'multiplication':
                case 'claw_multiplication':
                    return 'Multiplication Quest ✖️';
                case 'division':
                case 'claw_division':
                    return 'Division Challenge ➗';
                case 'openworld':
                case 'mixed':
                    return 'Open World Mix 🌍';
                default:
                    return `${op.charAt(0).toUpperCase()}${op.slice(1)} Game`;
            }
        }

        function isLikelyQuizResult(obj) {
            if (!obj || typeof obj !== 'object') {
                return false;
            }
            return (
                Object.prototype.hasOwnProperty.call(obj, 'score') ||
                Object.prototype.hasOwnProperty.call(obj, 'finalScore') ||
                Object.prototype.hasOwnProperty.call(obj, 'correct') ||
                Object.prototype.hasOwnProperty.call(obj, 'incorrect') ||
                Object.prototype.hasOwnProperty.call(obj, 'answered') ||
                Object.prototype.hasOwnProperty.call(obj, 'accuracy') ||
                (Object.prototype.hasOwnProperty.call(obj, 'quizId') && Object.prototype.hasOwnProperty.call(obj, 'studentId')) ||
                (Object.prototype.hasOwnProperty.call(obj, 'quiz') && Object.prototype.hasOwnProperty.call(obj, 'userId'))
            );
        }

        function normalizeQuizResultEntry(entry, fallback = {}) {
            if (!entry || typeof entry !== 'object') {
                return null;
            }

            const scoreCandidate = entry.score !== undefined ? Number(entry.score) :
                (entry.finalScore !== undefined ? Number(entry.finalScore) : null);
            const score = Number.isFinite(scoreCandidate) ? scoreCandidate : 0;

            const correctCandidate = entry.correct !== undefined ? Number(entry.correct) :
                (entry.right !== undefined ? Number(entry.right) : null);
            const incorrectCandidate = entry.incorrect !== undefined ? Number(entry.incorrect) :
                (entry.wrong !== undefined ? Number(entry.wrong) : null);

            let answered = entry.answered !== undefined ? Number(entry.answered) : null;
            if (!Number.isFinite(answered) && (Number.isFinite(correctCandidate) || Number.isFinite(incorrectCandidate))) {
                answered = (Number(correctCandidate) || 0) + (Number(incorrectCandidate) || 0);
            }

            const timeCandidate = entry.timeSeconds !== undefined ? Number(entry.timeSeconds) :
                (entry.timeTaken !== undefined ? Number(entry.timeTaken) : null);

            const accuracyCandidate = entry.accuracy !== undefined ? Number(entry.accuracy) : null;

            const studentId = entry.studentId || entry.userId || entry.uid || fallback.studentId || '';
            const quizId = entry.quizId || entry.quiz || entry.quizKey || fallback.quizId || '';
            const operation = entry.operation || entry.mathOperation || fallback.operation || '';
            const timestamp = entry.timestamp || entry.timestampUtc || entry.completedAt || entry.finishedAt || entry.lastUpdated || fallback.timestamp || '';
            const fullName = entry.fullName || entry.studentName || fallback.fullName || '';
            const username = entry.username || fallback.username || '';

            return {
                studentId,
                quizId,
                score,
                correct: Number.isFinite(correctCandidate) ? correctCandidate : null,
                incorrect: Number.isFinite(incorrectCandidate) ? incorrectCandidate : null,
                answered: Number.isFinite(answered) ? answered : null,
                timeSeconds: Number.isFinite(timeCandidate) ? timeCandidate : null,
                accuracy: Number.isFinite(accuracyCandidate) ? Math.round(accuracyCandidate * 100) / 100 : null,
                operation,
                timestamp,
                fullName,
                username,
                raw: entry
            };
        }

        function chooseLatestTimestamp(existingTimestamp, candidateTimestamp) {
            if (!candidateTimestamp) {
                return existingTimestamp || '';
            }
            if (!existingTimestamp) {
                return candidateTimestamp;
            }
            const existingTime = Date.parse(existingTimestamp);
            const candidateTime = Date.parse(candidateTimestamp);
            if (Number.isNaN(candidateTime)) {
                return existingTimestamp;
            }
            if (Number.isNaN(existingTime)) {
                return candidateTimestamp;
            }
            return candidateTime > existingTime ? candidateTimestamp : existingTimestamp;
        }

        function aggregateAllQuizResults(quizzesSnapshot, quizResultsSnapshot) {
            const aggregatedResults = [];
            const quizMetaById = new Map();

            if (quizzesSnapshot) {
                quizzesSnapshot.forEach(child => {
                    const quizId = child.key;
                    const quiz = child.val() || {};
                    quizMetaById.set(quizId, quiz);

                    if (quiz.studentResults && typeof quiz.studentResults === 'object') {
                        Object.entries(quiz.studentResults).forEach(([entryId, value]) => {
                            if (!isLikelyQuizResult(value)) {
                                return;
                            }

                            const normalized = normalizeQuizResultEntry(value, {
                                quizId,
                                operation: quiz.operation || '',
                                fullName: value.fullName || '',
                                username: value.username || ''
                            });

                            if (normalized) {
                                normalized.quizMeta = quiz;
                                normalized.entryId = entryId;
                                aggregatedResults.push(normalized);
                            }
                        });
                    }
                });
            }

            if (quizResultsSnapshot) {
                quizResultsSnapshot.forEach(operationNode => {
                    const operationKey = operationNode.key;
                    operationNode.forEach(resultNode => {
                        const rawEntry = resultNode.val() || {};

                        // Handle nested structure where data might be in 'lastResult'
                        let entryData = rawEntry;
                        if (rawEntry.lastResult && typeof rawEntry.lastResult === 'object') {
                            entryData = rawEntry.lastResult;
                        }

                        if (!isLikelyQuizResult(entryData)) {
                            return;
                        }

                        const quizId = entryData.quizId || entryData.quizKey || entryData.quiz;
                        const quizMeta = quizMetaById.get(quizId) || null;
                        const normalized = normalizeQuizResultEntry(entryData, {
                            quizId,
                            operation: quizMeta && quizMeta.operation ? quizMeta.operation : operationKey,
                            fullName: entryData.fullName || entryData.studentName || '',
                            username: entryData.username || ''
                        });

                        if (normalized) {
                            normalized.quizMeta = quizMeta;
                            normalized.entryId = resultNode.key;
                            aggregatedResults.push(normalized);
                        }
                    });
                });
            }

            return aggregatedResults;
        }

        function buildStudentMetrics(allUsersSnapshot, aggregatedResults) {
            const students = new Map();

            if (allUsersSnapshot) {
                allUsersSnapshot.forEach(child => {
                    const userId = child.key;
                    const value = child.val() || {};
                    if (value.isAdmin) {
                        return;
                    }

                    students.set(userId, {
                        id: userId,
                        username: value.username || '',
                        fullname: value.fullname || '',
                        email: value.email || '',
                        createdAt: value.createdAt || '',
                        lastLogin: value.lastLogin || '',
                        CWHighScore: value.CWHighScore || 0,
                        OPHighScore: value.OPHighScore || 0,
                        attempts: 0,
                        totalScore: 0,
                        maxScore: 0,
                        latestActivity: value.lastLogin || value.createdAt || '',
                        operationStats: {},
                        isFromDatabase: true
                    });
                });
            }

            aggregatedResults.forEach(result => {
                const studentId = result.studentId || ''; 
                const username = result.username || ''; 
                let student = null;

                if (students.has(studentId)) {
                    student = students.get(studentId);
                } else if (username) {
                    student = [...students.values()].find(s => s.username === username);
                }

                if (!student) {
                    const fallbackId = studentId || `username:${username}` || `unknown:${Math.random().toString(36).slice(2)}`;
                    student = {
                        id: fallbackId,
                        username,
                        fullname: result.fullName || username || 'Unknown Student',
                        email: '',
                        createdAt: '',
                        lastLogin: '',
                        CWHighScore: 0,
                        OPHighScore: 0,
                        attempts: 0,
                        totalScore: 0,
                        maxScore: 0,
                        latestActivity: '',
                        operationStats: {},
                        isFromDatabase: false
                    };
                    students.set(fallbackId, student);
                }

                student.attempts += 1;
                student.totalScore += Number(result.score) || 0;
                student.maxScore = Math.max(student.maxScore, Number(result.score) || 0);
                student.latestActivity = chooseLatestTimestamp(student.latestActivity, result.timestamp);

                const operationKey = (result.operation || 'mixed').toLowerCase();
                if (!student.operationStats[operationKey]) {
                    student.operationStats[operationKey] = {
                        attempts: 0,
                        totalScore: 0,
                        maxScore: 0
                    };
                }
                const opStats = student.operationStats[operationKey];
                opStats.attempts += 1;
                opStats.totalScore += Number(result.score) || 0;
                opStats.maxScore = Math.max(opStats.maxScore, Number(result.score) || 0);
            });

            return [...students.values()];
        }

        function buildQuizMetrics(quizzesSnapshot, aggregatedResults) {
            const quizzes = new Map();

            if (quizzesSnapshot) {
                quizzesSnapshot.forEach(child => {
                    const quizId = child.key;
                    const quiz = child.val() || {};

                    quizzes.set(quizId, {
                        id: quizId,
                        name: quiz.name || 'Untitled Quiz',
                        type: quiz.type || 'unknown',
                        operation: quiz.operation || 'mixed',
                        attempts: 0,
                        totalScore: 0,
                        maxScore: 0,
                        lastAttempt: quiz.createdAt || '',
                        questionCount: computeQuestionCount(quiz)
                    });
                });
            }

            aggregatedResults.forEach(result => {
                const quizId = result.quizId;
                if (!quizId) {
                    return;
                }

                if (!quizzes.has(quizId)) {
                    quizzes.set(quizId, {
                        id: quizId,
                        name: result.quizMeta && result.quizMeta.name ? result.quizMeta.name : 'Untitled Quiz',
                        type: result.quizMeta && result.quizMeta.type ? result.quizMeta.type : 'unknown',
                        operation: result.operation || 'mixed',
                        attempts: 0,
                        totalScore: 0,
                        maxScore: 0,
                        lastAttempt: '',
                        questionCount: result.quizMeta ? computeQuestionCount(result.quizMeta) : 0
                    });
                }

                const quizStats = quizzes.get(quizId);
                quizStats.attempts += 1;
                quizStats.totalScore += Number(result.score) || 0;
                quizStats.maxScore = Math.max(quizStats.maxScore, Number(result.score) || 0);
                quizStats.lastAttempt = chooseLatestTimestamp(quizStats.lastAttempt, result.timestamp);
            });

            return [...quizzes.values()];
        }

        function countRegisteredStudents(usersSnapshot) {
            let count = 0;
            if (!usersSnapshot) {
                return count;
            }

            usersSnapshot.forEach(child => {
                const val = child.val() || {};
                if (!val.isAdmin) {
                    count += 1;
                }
            });

            return count;
        }

        function updateReportSummary(usersSnapshot, studentMetrics, quizMetrics, aggregatedResults) {
            const totalStudentsEl = document.getElementById('reportTotalStudents');
            const activeStudentsEl = document.getElementById('reportActiveStudents');
            const totalQuizzesEl = document.getElementById('reportTotalQuizzes');
            const totalAttemptsEl = document.getElementById('reportTotalAttempts');
            const averageScoreEl = document.getElementById('reportAverageScore');
            const successRateEl = document.getElementById('reportSuccessRate');
            const popularOperationEl = document.getElementById('reportPopularOperation');
            const avgTimeEl = document.getElementById('reportAvgTime');

            const totalStudents = countRegisteredStudents(usersSnapshot);
            const activeStudents = studentMetrics.filter(student => student.attempts > 0).length;
            const totalQuizzes = quizMetrics.length;
            const totalAttempts = aggregatedResults.length;

            // Calculate average score
            const totalScore = aggregatedResults.reduce((sum, result) => sum + (result.score || 0), 0);
            const averageScore = totalAttempts > 0 ? Math.round(totalScore / totalAttempts) : 0;

            // Calculate success rate (students scoring 70% or higher)
            const successfulStudents = studentMetrics.filter(student => {
                if (student.attempts === 0) return false;
                const avgStudentScore = student.totalScore / student.attempts;
                return avgStudentScore >= 70; // Assuming max score is 100
            }).length;
            const successRate = activeStudents > 0 ? Math.round((successfulStudents / activeStudents) * 100) : 0;

            // Find most popular operation
            const operationCounts = {};
            aggregatedResults.forEach(result => {
                const operation = result.operation || 'mixed';
                operationCounts[operation] = (operationCounts[operation] || 0) + 1;
            });
            const popularOperation = Object.keys(operationCounts).reduce((a, b) => 
                operationCounts[a] > operationCounts[b] ? a : b, 'mixed'
            );

            // Calculate average time per quiz
            const totalTime = aggregatedResults.reduce((sum, result) => sum + (result.timeSeconds || 0), 0);
            const avgTimeSeconds = totalAttempts > 0 ? Math.round(totalTime / totalAttempts) : 0;

            // Update DOM elements
            if (totalStudentsEl) totalStudentsEl.textContent = totalStudents;
            if (activeStudentsEl) activeStudentsEl.textContent = activeStudents;
            if (totalQuizzesEl) totalQuizzesEl.textContent = totalQuizzes;
            if (totalAttemptsEl) totalAttemptsEl.textContent = totalAttempts;
            if (averageScoreEl) averageScoreEl.textContent = averageScore;
            if (successRateEl) successRateEl.textContent = `${successRate}%`;
            if (popularOperationEl) popularOperationEl.textContent = formatOperationName(popularOperation);
            if (avgTimeEl) avgTimeEl.textContent = formatDurationFromSeconds(avgTimeSeconds);
        }

        function formatOperationName(operation) {
            switch (operation.toLowerCase()) {
                case 'addition': return '➕ Addition';
                case 'subtraction': return '➖ Subtraction';
                case 'multiplication': return '✖️ Multiplication';
                case 'division': return '➗ Division';
                case 'mixed': return '🌍 Mixed';
                default: return operation.charAt(0).toUpperCase() + operation.slice(1);
            }
        }

        function updatePerformanceInsights(studentMetrics, aggregatedResults) {
            // Update Top Performers
            updateTopPerformers(studentMetrics);
            
            // Update Operation Breakdown
            updateOperationBreakdown(aggregatedResults);
            
            // Update Time Analysis
            updateTimeAnalysis(aggregatedResults);
        }

        function updateTopPerformers(studentMetrics) {
            const topPerformersEl = document.getElementById('topPerformersList');
            if (!topPerformersEl) return;

            const activeStudents = studentMetrics.filter(student => student.attempts > 0);
            const topPerformers = activeStudents
                .sort((a, b) => (b.totalScore / b.attempts) - (a.totalScore / a.attempts))
                .slice(0, 5);

            if (topPerformers.length === 0) {
                topPerformersEl.innerHTML = '<div style="padding: 8px 0; color: #6c7aa0;">No performance data available</div>';
                return;
            }

            const performersHTML = topPerformers.map((student, index) => {
                const avgScore = Math.round(student.totalScore / student.attempts);
                const medal = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : '🏅';
                return `
                    <div style="padding: 8px 0; border-bottom: 1px solid rgba(34, 197, 94, 0.1); display: flex; justify-content: space-between; align-items: center;">
                        <span>${medal} ${student.fullname || student.username || 'Unknown'}</span>
                        <span style="font-weight: 600; color: #15803d;">${avgScore} pts</span>
                    </div>
                `;
            }).join('');

            topPerformersEl.innerHTML = performersHTML;
        }

        function updateOperationBreakdown(aggregatedResults) {
            const breakdownEl = document.getElementById('operationBreakdown');
            if (!breakdownEl) return;

            const operationStats = {};
            aggregatedResults.forEach(result => {
                const operation = result.operation || 'mixed';
                if (!operationStats[operation]) {
                    operationStats[operation] = { count: 0, totalScore: 0, totalTime: 0 };
                }
                operationStats[operation].count++;
                operationStats[operation].totalScore += result.score || 0;
                operationStats[operation].totalTime += result.timeSeconds || 0;
            });

            const operations = Object.keys(operationStats);
            if (operations.length === 0) {
                breakdownEl.innerHTML = '<div style="padding: 8px 0; color: #6c7aa0;">No operation data available</div>';
                return;
            }

            const breakdownHTML = operations.map(operation => {
                const stats = operationStats[operation];
                const avgScore = Math.round(stats.totalScore / stats.count);
                const avgTime = Math.round(stats.totalTime / stats.count);
                const percentage = Math.round((stats.count / aggregatedResults.length) * 100);
                
                return `
                    <div style="padding: 8px 0; border-bottom: 1px solid rgba(59, 130, 246, 0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <span style="font-weight: 600;">${formatOperationName(operation)}</span>
                            <span style="color: #2563eb;">${percentage}%</span>
                        </div>
                        <div style="font-size: 12px; color: #6c7aa0;">
                            ${stats.count} attempts • Avg: ${avgScore} pts • ${formatDurationFromSeconds(avgTime)}
                        </div>
                    </div>
                `;
            }).join('');

            breakdownEl.innerHTML = breakdownHTML;
        }

        function updateTimeAnalysis(aggregatedResults) {
            const timeAnalysisEl = document.getElementById('timeAnalysis');
            if (!timeAnalysisEl) return;

            if (aggregatedResults.length === 0) {
                timeAnalysisEl.innerHTML = '<div style="padding: 8px 0; color: #6c7aa0;">No time data available</div>';
                return;
            }

            const times = aggregatedResults.map(result => result.timeSeconds || 0).filter(time => time > 0);
            if (times.length === 0) {
                timeAnalysisEl.innerHTML = '<div style="padding: 8px 0; color: #6c7aa0;">No time data available</div>';
                return;
            }

            const sortedTimes = times.sort((a, b) => a - b);
            const fastest = sortedTimes[0];
            const slowest = sortedTimes[sortedTimes.length - 1];
            const median = sortedTimes[Math.floor(sortedTimes.length / 2)];
            const average = Math.round(times.reduce((sum, time) => sum + time, 0) / times.length);

            const timeAnalysisHTML = `
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span>⚡ Fastest</span>
                        <span style="font-weight: 600; color: #7c3aed;">${formatDurationFromSeconds(fastest)}</span>
                    </div>
                </div>
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span>🐌 Slowest</span>
                        <span style="font-weight: 600; color: #7c3aed;">${formatDurationFromSeconds(slowest)}</span>
                    </div>
                </div>
                <div style="padding: 8px 0; border-bottom: 1px solid rgba(168, 85, 247, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span>📊 Average</span>
                        <span style="font-weight: 600; color: #7c3aed;">${formatDurationFromSeconds(average)}</span>
                    </div>
                </div>
                <div style="padding: 8px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <span>🎯 Median</span>
                        <span style="font-weight: 600; color: #7c3aed;">${formatDurationFromSeconds(median)}</span>
                    </div>
                </div>
            `;

            timeAnalysisEl.innerHTML = timeAnalysisHTML;
        }

        function renderQuizSummaryTable(quizMetrics) {
            const tbody = document.getElementById('reportQuizSummaryBody');
            if (!tbody) {
                return;
            }

            if (!quizMetrics || quizMetrics.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 24px; color: #6c7aa0;">
                            No quiz data available. Click refresh to load report.
                        </td>
                    </tr>
                `;
                return;
            }

            const rowsHtml = quizMetrics
                .sort((a, b) => new Date(b.lastAttempt || 0) - new Date(a.lastAttempt || 0))
                .map(quiz => {
                    const averageScore = quiz.attempts > 0 ? (quiz.totalScore / quiz.attempts) : 0;
                    const lastAttemptDisplay = quiz.lastAttempt ? new Date(quiz.lastAttempt).toLocaleString() : '—';
                    return `
                        <tr>
                            <td>${quiz.name}</td>
                            <td>${formatQuizTypeLabel(quiz.type)}</td>
                            <td>${quiz.attempts}</td>
                            <td>${averageScore.toFixed(1)}</td>
                            <td>${quiz.maxScore}</td>
                            <td>${lastAttemptDisplay}</td>
                        </tr>
                    `;
                })
                .join('');

            tbody.innerHTML = rowsHtml;
        }

        function renderActiveStudentsTable(studentMetrics) {
            const tbody = document.getElementById('reportActiveStudentsBody');
            if (!tbody) {
                return;
            }

            const activeStudents = studentMetrics.filter(student => student.attempts > 0);

            if (activeStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 24px; color: #6c7aa0;">
                            No activity data yet. Recent quiz attempts will appear here.
                        </td>
                    </tr>
                `;
                return;
            }

            const rowsHtml = activeStudents
                .sort((a, b) => {
                    if (b.attempts !== a.attempts) {
                        return b.attempts - a.attempts;
                    }
                    return b.totalScore - a.totalScore;
                })
                .slice(0, 10)
                .map(student => {
                    const averageScore = student.attempts > 0 ? (student.totalScore / student.attempts) : 0;
                    const bestOperation = Object.entries(student.operationStats || {})
                        .sort(([, aStats], [, bStats]) => bStats.maxScore - aStats.maxScore)[0];

                    const bestOperationLabel = bestOperation
                        ? formatOperationLabel(bestOperation[0])
                        : 'Mixed Fun';

                    const lastActivityDisplay = student.latestActivity
                        ? new Date(student.latestActivity).toLocaleString()
                        : '—';

                    return `
                        <tr>
                            <td>${student.fullname || student.username || 'Unknown Student'}</td>
                            <td>${student.attempts}</td>
                            <td>${averageScore.toFixed(1)}</td>
                            <td>${bestOperationLabel}</td>
                            <td>${lastActivityDisplay}</td>
                        </tr>
                    `;
                })
                .join('');

            tbody.innerHTML = rowsHtml;
        }

        function renderReportError(message) {
            const cards = ['reportTotalStudents', 'reportActiveStudents', 'reportTotalQuizzes', 'reportTotalAttempts', 
                          'reportAverageScore', 'reportSuccessRate', 'reportPopularOperation', 'reportAvgTime'];
            cards.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = '—';
                }
            });

            const quizTableBody = document.getElementById('reportQuizSummaryBody');
            if (quizTableBody) {
                quizTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 24px; color: #b91c1c;">
                            ${message}
                        </td>
                    </tr>
                `;
            }

            const studentsTableBody = document.getElementById('reportActiveStudentsBody');
            if (studentsTableBody) {
                studentsTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 24px; color: #b91c1c;">
                            ${message}
                        </td>
                    </tr>
                `;
            }
        }

        function renderReportLoadingState() {
            const loaderHtml = `
                <tr>
                    <td colspan="100" style="text-align: center; padding: 24px; color: #6c7aa0;">
                        <span class="loading"></span> Loading data...
                    </td>
                </tr>
            `;

            const quizTableBody = document.getElementById('reportQuizSummaryBody');
            if (quizTableBody) {
                quizTableBody.innerHTML = loaderHtml.replace('colspan="100"', 'colspan="7"');
            }

            const studentsTableBody = document.getElementById('reportActiveStudentsBody');
            if (studentsTableBody) {
                studentsTableBody.innerHTML = loaderHtml.replace('colspan="100"', 'colspan="5"');
            }
        }

        function formatDashboardOperation(operation) {
            switch ((operation || '').toLowerCase()) {
                case 'addition':
                case 'claw_addition':
                    return 'Addition';
                case 'subtraction':
                case 'claw_subtraction':
                    return 'Subtraction';
                case 'multiplication':
                case 'claw_multiplication':
                    return 'Multiplication';
                case 'division':
                case 'claw_division':
                    return 'Division';
                case 'openworld':
                case 'mixed':
                    return 'Mixed Operations';
                default:
                    return operation || 'Mixed Operations';
            }
        }

        function updateDashboardWidgets(metrics) {
            if (!metrics) {
                return;
            }

            const {
                activeToday = 0,
                quizzesCompletedToday = 0,
                topStudent = null,
                classSkillLevel = 'Growing 🌱',
                topGame = { name: 'Loading...', detail: 'Checking today’s favorites...' },
                trickyTopic = { name: 'Loading...', detail: 'Analyzing quiz results...' },
                averageScore = { value: 'Loading...', detail: 'Gathering class results...' },
                badges = { value: 'Loading...', detail: 'Celebrating stars soon!' }
            } = metrics;

            const activeTodayEl = document.getElementById('dashboardActiveToday');
            const quizzesCompletedEl = document.getElementById('dashboardQuizzesCompleted');
            const classStarEl = document.getElementById('dashboardClassStar');
            const skillLevelEl = document.getElementById('dashboardSkillLevel');
            const topGameEl = document.getElementById('dashboardTopGame');
            const topGameDetailEl = document.getElementById('dashboardTopGameDetail');
            const trickyTopicEl = document.getElementById('dashboardTrickyTopic');
            const trickyTopicDetailEl = document.getElementById('dashboardTrickyTopicDetail');
            const averageScoreEl = document.getElementById('dashboardAverageScore');
            const averageScoreDetailEl = document.getElementById('dashboardAverageScoreDetail');
            const badgesEl = document.getElementById('dashboardBadgesEarned');
            const badgesDetailEl = document.getElementById('dashboardBadgesDetail');

            if (activeTodayEl) activeTodayEl.textContent = activeToday;
            if (quizzesCompletedEl) quizzesCompletedEl.textContent = quizzesCompletedToday;
            if (classStarEl) classStarEl.textContent = topStudent ? topStudent.name : 'N/A';
            if (skillLevelEl) skillLevelEl.textContent = classSkillLevel;
            if (topGameEl) topGameEl.textContent = topGame.name;
            if (topGameDetailEl) topGameDetailEl.textContent = topGame.detail;
            if (trickyTopicEl) trickyTopicEl.textContent = trickyTopic.name;
            if (trickyTopicDetailEl) trickyTopicDetailEl.textContent = trickyTopic.detail;
            if (averageScoreEl) averageScoreEl.textContent = averageScore.value;
            if (averageScoreDetailEl) averageScoreDetailEl.textContent = averageScore.detail;
            if (badgesEl) badgesEl.textContent = badges.value;
            if (badgesDetailEl) badgesDetailEl.textContent = badges.detail;
        }

        let lastReportLoadPromise = null;

        async function loadDataReport(showSpinner = true) {
            if (!database) {
                renderReportError('Firebase is not initialized.');
                return;
            }

            if (showSpinner) {
                renderReportLoadingState();
            }

            try {
                const [usersSnapshot, quizzesSnapshot, quizResultsSnapshot] = await Promise.all([
                    get(ref(database, 'users')),
                    get(ref(database, 'quizzes')),
                    get(ref(database, 'quizManagement'))
                ]);

                const aggregatedResults = aggregateAllQuizResults(quizzesSnapshot, quizResultsSnapshot);
                const studentMetrics = buildStudentMetrics(usersSnapshot, aggregatedResults);
                const quizMetrics = buildQuizMetrics(quizzesSnapshot, aggregatedResults);

                updateReportSummary(usersSnapshot, studentMetrics, quizMetrics, aggregatedResults);
                renderQuizSummaryTable(quizMetrics);
                renderActiveStudentsTable(studentMetrics);

                const metrics = computeDashboardMetrics(studentMetrics, aggregatedResults, quizMetrics);
                updateDashboardWidgets(metrics);
                
                // Update performance insights
                updatePerformanceInsights(studentMetrics, aggregatedResults);
            } catch (error) {
                console.error('Failed to load data report:', error);
                renderReportError('Unable to load report data. Please try again.');
            }
        }

        function computeDashboardMetrics(studentMetrics, aggregatedResults, quizMetrics) {
            const today = new Date().toDateString();

            const activeToday = studentMetrics.filter(student => {
                if (!student.latestActivity) {
                    return false;
                }
                const activityDate = new Date(student.latestActivity).toDateString();
                return activityDate === today;
            }).length;

            const quizzesCompletedToday = aggregatedResults.filter(result => {
                if (!result.timestamp) {
                    return false;
                }
                const attemptDate = new Date(result.timestamp).toDateString();
                return attemptDate === today;
            }).length;

            const topStudent = studentMetrics
                .filter(student => student.attempts > 0)
                .sort((a, b) => b.totalScore - a.totalScore)[0] || null;

            let classSkillLevel = 'Growing 🌱';
            const totalAttempts = aggregatedResults.length;
            if (totalAttempts > 0) {
                const totalCorrect = aggregatedResults.reduce((sum, result) => {
                    if (Number.isFinite(result.correct)) {
                        return sum + result.correct;
                    }
                    if (Number.isFinite(result.answered)) {
                        return sum + Math.max(0, result.answered - (result.incorrect || 0));
                    }
                    return sum;
                }, 0);
                const totalAnswered = aggregatedResults.reduce((sum, result) => {
                    if (Number.isFinite(result.answered)) {
                        return sum + result.answered;
                    }
                    return sum + (Number.isFinite(result.correct) ? result.correct : 0) + (Number.isFinite(result.incorrect) ? result.incorrect : 0);
                }, 0);

                const accuracy = totalAnswered > 0 ? (totalCorrect / totalAnswered) * 100 : 0;
                if (accuracy >= 85) {
                    classSkillLevel = 'Flying High 🦅';
                } else if (accuracy >= 60) {
                    classSkillLevel = 'Getting Strong 💪';
                }
            }

            const operationCounts = aggregatedResults.reduce((acc, result) => {
                const key = (result.operation || 'mixed').toLowerCase();
                acc[key] = (acc[key] || 0) + 1;
                return acc;
            }, {});

            const topOperationEntry = Object.entries(operationCounts)
                .sort(([, aCount], [, bCount]) => bCount - aCount)[0];

            const topGame = topOperationEntry
                ? {
                    name: formatOperationLabel(topOperationEntry[0]),
                    detail: `${topOperationEntry[1]} attempt${topOperationEntry[1] === 1 ? '' : 's'} today`
                }
                : {
                    name: 'No data yet',
                    detail: 'Students will appear after quiz attempts'
                };

            let trickyTopic = {
                name: 'Analyzing...',
                detail: 'Not enough attempts yet'
            };

            if (aggregatedResults.length > 0) {
                const accuracyByOperation = {};
                aggregatedResults.forEach(result => {
                    const key = (result.operation || 'mixed').toLowerCase();
                    if (!accuracyByOperation[key]) {
                        accuracyByOperation[key] = {
                            correct: 0,
                            answered: 0
                        };
                    }
                    const bucket = accuracyByOperation[key];
                    bucket.correct += Number.isFinite(result.correct) ? result.correct : 0;
                    bucket.answered += Number.isFinite(result.answered) ? result.answered : 0;
                });

                const trickyOperationEntry = Object.entries(accuracyByOperation)
                    .filter(([, stats]) => stats.answered >= 3)
                    .map(([operation, stats]) => {
                        const accuracy = stats.answered > 0 ? (stats.correct / stats.answered) * 100 : 0;
                        return [operation, accuracy];
                    })
                    .sort(([, aAccuracy], [, bAccuracy]) => aAccuracy - bAccuracy)[0];

                if (trickyOperationEntry) {
                    trickyTopic = {
                        name: formatOperationLabel(trickyOperationEntry[0]),
                        detail: `${trickyOperationEntry[1].toFixed(0)}% accuracy`
                    };
                } else {
                    trickyTopic = {
                        name: 'Need more attempts',
                        detail: 'Encourage students to try more quizzes'
                    };
                }
            }

            const averageScoreValue = aggregatedResults.length > 0
                ? (aggregatedResults.reduce((sum, result) => sum + (Number(result.score) || 0), 0) / aggregatedResults.length)
                : 0;

            const averageScore = {
                value: `${averageScoreValue.toFixed(1)}`,
                detail: aggregatedResults.length > 0
                    ? `Across ${aggregatedResults.length} attempt${aggregatedResults.length === 1 ? '' : 's'}`
                    : 'No attempts yet'
            };

            const badges = {
                value: `${Math.min(quizzesCompletedToday, 10)}`,
                detail: quizzesCompletedToday > 0
                    ? 'Stars earned from today’s quizzes'
                    : 'Encourage more quiz plays'
            };

            return {
                activeToday,
                quizzesCompletedToday,
                topStudent: topStudent ? {
                    name: topStudent.fullname || topStudent.username,
                    score: topStudent.totalScore
                } : null,
                classSkillLevel,
                topGame,
                trickyTopic,
                averageScore,
                badges
            };
        }

        let questionCounter = 0;

        window.openAddQuizModal = function() {
            const modal = document.getElementById('addQuizModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Reset form
            document.getElementById('addQuizForm').reset();
            document.getElementById('questionsContainer').innerHTML = '';
            document.getElementById('operationGroup').style.display = 'none';
            questionCounter = 0;
            
            // Add initial question row
            addQuestionRow();
        }

        window.closeAddQuizModal = function() {
            const modal = document.getElementById('addQuizModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Clear message
            const messageDiv = document.getElementById('addQuizMessage');
            messageDiv.style.display = 'none';
        }

        window.updateOperationOptions = function() {
            const quizType = document.getElementById('quizType').value;
            const operationGroup = document.getElementById('operationGroup');
            const operationSelect = document.getElementById('quizOperation');
            const questionsContainer = document.getElementById('questionsContainer');
            
            if (isSpecificClawMachineType(quizType)) {
                // Hide the manual operation selector; operation comes from type
                operationGroup.style.display = 'none';
                operationSelect.required = false;
                operationSelect.value = getClawOperationFromType(quizType);
                updateQuestionRowsForSpecificClawMachine(quizType);
            } else if (quizType === 'clawmachine') {
                // Show operation selector for legacy Claw Machine
                operationGroup.style.display = 'block';
                operationSelect.required = true;
                operationSelect.value = '';
                updateQuestionRowsForClawMachine();
            } else if (quizType === 'openworld') {
                // Hide operation selector for Open World
                operationGroup.style.display = 'none';
                operationSelect.required = false;
                operationSelect.value = '';
                
                // Update all question rows to enable operator selection
                updateQuestionRowsForOpenWorld();
            } else {
                operationGroup.style.display = 'none';
                operationSelect.required = false;
            }
        }

        window.addQuestionRow = function() {
            const quizType = document.getElementById('quizType').value;
            let selectedOperation = document.getElementById('quizOperation').value;
            const container = document.getElementById('questionsContainer');
            
            questionCounter++;
            const questionId = `question_${questionCounter}`;
            
            const questionRow = document.createElement('div');
            questionRow.className = 'question-row';
            questionRow.id = questionId;
            
            let operatorHTML = '';
            if (isSpecificClawMachineType(quizType)) {
                selectedOperation = getClawOperationFromType(quizType);
            }

            if (isClawMachineType(quizType) && selectedOperation) {
                // Fixed operator based on selected operation
                const symbol = getOperationSymbol(selectedOperation);
                operatorHTML = `<input type="text" value="${symbol}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
            } else if (quizType === 'openworld') {
                // Dropdown for mixed operations
                operatorHTML = `
                    <select class="operator-select" name="operator_${questionCounter}" required onchange="calculateAnswer('${questionId}')">
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="×">×</option>
                        <option value="÷">÷</option>
                    </select>
                `;
            } else {
                operatorHTML = `<input type="text" placeholder="Op" readonly style="text-align: center; background-color: #f0f0f0;">`;
            }
            
            questionRow.innerHTML = `
                <input type="number" placeholder="First number" name="num1_${questionCounter}" required oninput="calculateAnswer('${questionId}')">
                ${operatorHTML}
                <input type="number" placeholder="Second number" name="num2_${questionCounter}" required oninput="calculateAnswer('${questionId}')">
                <span style="text-align: center; font-weight: 600; font-size: 18px;">=</span>
                <input type="number" placeholder="Answer" name="answer_${questionCounter}" required readonly style="background-color: rgba(34, 197, 94, 0.1); color: #15803d; font-weight: 600;">
                <button type="button" class="remove-btn" onclick="removeQuestionRow('${questionId}')" title="Remove question">×</button>
            `;
            
            container.appendChild(questionRow);
        }

        window.removeQuestionRow = function(questionId) {
            const row = document.getElementById(questionId);
            if (row) {
                row.remove();
            }
        }

        // Auto-calculate answer for quiz questions
        window.calculateAnswer = function(questionId) {
            const row = document.getElementById(questionId);
            if (!row) return;

            const num1Input = row.querySelector('input[name^="num1_"]');
            const num2Input = row.querySelector('input[name^="num2_"]');
            const answerInput = row.querySelector('input[name^="answer_"]');
            const operatorElement = row.children[1];

            if (!num1Input || !num2Input || !answerInput || !operatorElement) return;

            const num1 = parseFloat(num1Input.value);
            const num2 = parseFloat(num2Input.value);

            // Get operator from the element
            let operator = '';
            if (operatorElement.tagName === 'SELECT') {
                operator = operatorElement.value;
            } else if (operatorElement.tagName === 'INPUT') {
                operator = operatorElement.value;
            }

            // Only calculate if both numbers are valid and operator is set
            if (!isNaN(num1) && !isNaN(num2) && operator) {
                let result = 0;
                
                switch (operator) {
                    case '+':
                        result = num1 + num2;
                        break;
                    case '-':
                        result = num1 - num2;
                        break;
                    case '×':
                        result = num1 * num2;
                        break;
                    case '÷':
                        if (num2 !== 0) {
                            result = num1 / num2;
                        } else {
                            result = 0; // Division by zero
                        }
                        break;
                    default:
                        return;
                }

                // Round to 2 decimal places for division results
                if (operator === '÷' && result % 1 !== 0) {
                    result = Math.round(result * 100) / 100;
                }

                answerInput.value = result;
            } else {
                answerInput.value = '';
            }
        }

        function updateQuestionRowsForClawMachine() {
            const selectedOperation = document.getElementById('quizOperation').value;
            const rows = document.querySelectorAll('.question-row');
            rows.forEach(row => {
                const operatorElement = row.children[1]; // Second element is operator
                if (selectedOperation) {
                    const symbol = getOperationSymbol(selectedOperation);
                    if (symbol) {
                        operatorElement.outerHTML = `<input type="text" value="${symbol}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
                    }
                }
            });
        }

        function updateQuestionRowsForSpecificClawMachine(quizType) {
            const operation = getClawOperationFromType(quizType);
            const symbol = getOperationSymbol(operation);
            if (!symbol) {
                return;
            }

            const rows = document.querySelectorAll('.question-row');
            rows.forEach(row => {
                const operatorElement = row.children[1];
                operatorElement.outerHTML = `<input type="text" value="${symbol}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
            });
        }

        function updateQuestionRowsForOpenWorld() {
            const rows = document.querySelectorAll('.question-row');
            rows.forEach((row, index) => {
                const operatorElement = row.children[1];
                const questionNum = index + 1;
                operatorElement.outerHTML = `
                    <select class="operator-select" name="operator_${questionNum}" required>
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="×">×</option>
                        <option value="÷">÷</option>
                    </select>
                `;
            });
        }

        window.saveQuiz = async function(event) {
            event.preventDefault();
            
            const quizName = document.getElementById('quizName').value.trim();
            const quizType = document.getElementById('quizType').value;
            const operation = document.getElementById('quizOperation').value;
            const attempts = parseInt(document.getElementById('quizAttempts').value);
            const scorePerQuestion = parseInt(document.getElementById('quizScore').value);
            const timeLimit = parseInt(document.getElementById('quizTimeLimit').value);
            const deadline = document.getElementById('quizDeadline').value;
            const container = document.getElementById('questionsContainer');
            const questionRows = container.querySelectorAll('.question-row');
            
            if (questionRows.length === 0) {
                showQuizMessage('Please add at least one question.', 'error');
                return;
            }
            
            // Collect all questions
            const questions = [];
            questionRows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input[type="number"]');
                const operatorElement = row.children[1];

                let operator = '';
                if (isSpecificClawMachineType(quizType)) {
                    operator = getOperationSymbol(getClawOperationFromType(quizType));
                } else if (quizType === 'clawmachine' || quizType === 'openworld') {
                    operator = operatorElement.value;
                }

                if (!operator) {
                    const resolvedOp = resolveOperationValue(quizType, operation);
                    if (resolvedOp && resolvedOp !== 'mixed') {
                        operator = getOperationSymbol(resolvedOp);
                    }
                }

                questions.push({
                    num1: parseInt(inputs[0].value),
                    operator: operator,
                    num2: parseInt(inputs[1].value),
                    answer: parseInt(inputs[2].value)
                });
            });
            
            // Create quiz object
            const quiz = {
                name: quizName,
                type: quizType,
                operation: resolveOperationValue(quizType, operation),
                attempts: attempts,
                scorePerQuestion: scorePerQuestion,
                timeLimit: timeLimit,
                deadline: deadline,
                questions: questions,
                createdAt: new Date().toISOString(),
                questionCount: questions.length,
                studentResults: {} // Will store student results
            };
            
            try {
                // Save to Firebase
                const quizId = 'quiz_' + Date.now();
                await set(ref(database, 'quizzes/' + quizId), quiz);
                
                showQuizMessage('Quiz created successfully!', 'success');
                
                // Clear Unity quiz ID to ensure new quiz starts fresh
                window.ClearUnityQuizId();
                
                // Refresh quiz list and close modal after short delay
                setTimeout(() => {
                    loadQuizzes();
                    closeAddQuizModal();
                }, 1500);
                
            } catch (error) {
                console.error('Error saving quiz:', error);
                showQuizMessage('Error creating quiz. Please try again.', 'error');
            }
        }

        function showQuizMessage(message, type) {
            const messageDiv = document.getElementById('addQuizMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'success' ? 'message success' : 'message error';
            messageDiv.style.display = 'block';
        }

        // Load and display all quizzes
        async function loadQuizzes() {
            try {
                const quizzesRef = ref(database, 'quizzes');
                const snapshot = await get(quizzesRef);
                
                const tableBody = document.getElementById('quizzesTableBody');
                
                if (!snapshot.exists()) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6c7aa0;">
                                No quizzes found. Click "Add Quiz" to create your first quiz!
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const quizzes = [];
                snapshot.forEach((childSnapshot) => {
                    const quizData = childSnapshot.val();
                    quizzes.push({
                        id: childSnapshot.key,
                        ...quizData
                    });
                });
                
                // Sort by creation date (newest first)
                quizzes.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Render quizzes
                tableBody.innerHTML = quizzes.map(quiz => {
                    const formattedType = formatQuizTypeLabel(quiz.type);
                    const typeIcon = quiz.type === 'openworld' ? '🌍' : '🎮';
                    const typeName = formattedType;
                    const operationName = quiz.operation === 'mixed' ? 'Mixed Operations' : 
                                         quiz.operation.charAt(0).toUpperCase() + quiz.operation.slice(1);
                    const date = new Date(quiz.createdAt).toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    
                    return `
                        <tr>
                            <td><strong>${quiz.name || 'Untitled Quiz'}</strong></td>
                            <td>${typeIcon} ${typeName}</td>
                            <td>${operationName}</td>
                            <td>${quiz.questionCount} questions</td>
                            <td>${quiz.attempts || 3}</td>
                            <td>${date}</td>
                            <td>
                                <div class="user-row-actions">
                                    <button class="small-btn" onclick="viewQuiz('${quiz.id}')">👁️ View</button>
                                    <button class="small-btn" onclick="editQuiz('${quiz.id}')">✏️ Edit</button>
                                    <button class="small-btn" onclick="deleteQuiz('${quiz.id}')">🗑️ Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading quizzes:', error);
            }
        }

        // View quiz details
        window.viewQuiz = async function(quizId) {
            try {
                const quizRef = ref(database, 'quizzes/' + quizId);
                const snapshot = await get(quizRef);
                
                if (snapshot.exists()) {
                    const quiz = snapshot.val();
                    
                    // Set Unity quiz ID so Unity knows which quiz results to submit to
                    window.SetUnityQuizId(quizId);
                    
                    const formattedType = formatQuizTypeLabel(quiz.type);
                    const typeIcon = quiz.type === 'openworld' ? '🌍' : '🎮';
                    const typeName = formattedType;
                    const operationName = quiz.operation === 'mixed' ? 'Mixed Operations' : 
                                         quiz.operation.charAt(0).toUpperCase() + quiz.operation.slice(1);
                    
                    // Set modal title
                    document.getElementById('viewQuizTitle').textContent = `📝 ${quiz.name || 'Untitled Quiz'}`;
                    
                    // Set quiz problems
                    const problemsHTML = quiz.questions.map((q, i) => `
                        <div class="problem-item">
                            <div class="problem-number">${i + 1}</div>
                            <div class="problem-equation">${q.num1} ${q.operator} ${q.num2} = ${q.answer}</div>
                        </div>
                    `).join('');
                    document.getElementById('viewQuizProblems').innerHTML = problemsHTML;
                    
                    const questionCount = computeQuestionCount(quiz);
                    const studentResultsTableBody = document.getElementById('viewQuizStudentsTableBody');
                    studentResultsTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6c7aa0;">Loading results...</td></tr>';

                    const results = await fetchQuizResultsForQuiz(quizId, quiz);

                    if (results.length === 0) {
                        studentResultsTableBody.innerHTML = `
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 20px; color: #6c7aa0;">
                                    No students have taken this quiz yet.
                                </td>
                            </tr>
                        `;
                    } else {
                        const resultsHTML = results.map(result => {
                            const timeFormatted = formatDurationFromSeconds(result.timeSeconds);
                const answeredSafe = Number.isFinite(result.answered) ? result.answered : (Number(result.correct) || 0) + (Number(result.incorrect) || 0);
                const answeredDisplay = questionCount > 0 ? `${answeredSafe}/${questionCount}` : `${answeredSafe}`;
                            const nameDisplay = result.fullName || (result.username ? `@${result.username}` : 'Unknown Student');
                                
                                return `
                                    <tr>
                                    <td>${nameDisplay}</td>
                                        <td><strong style="color: #667eea;">${result.score}</strong></td>
                                    <td>${result.correct}</td>
                                    <td>${result.incorrect}</td>
                                        <td>${timeFormatted}</td>
                                    <td>${answeredDisplay}</td>
                                    <td>${result.attemptsUsed || 1}</td>
                                    </tr>
                                `;
                        }).join('');

                        studentResultsTableBody.innerHTML = resultsHTML;
                    }
                    
                    // Open modal
                    const modal = document.getElementById('viewQuizModal');
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Error viewing quiz:', error);
                alert('Error loading quiz details.');
            }
        }

        // Close view quiz modal
        window.closeViewQuizModal = function() {
            const modal = document.getElementById('viewQuizModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Edit quiz - Load quiz data into edit modal
        window.editQuiz = async function(quizId) {
            try {
                const quizRef = ref(database, 'quizzes/' + quizId);
                const snapshot = await get(quizRef);
                
                if (snapshot.exists()) {
                    const quiz = snapshot.val();
                    
                    // Set quiz ID
                    document.getElementById('editQuizId').value = quizId;
                    
                    // Set basic fields
                    document.getElementById('editQuizName').value = quiz.name || '';
                    document.getElementById('editQuizType').value = quiz.type || '';
                    document.getElementById('editQuizAttempts').value = quiz.attempts || 3;
                    document.getElementById('editQuizScore').value = quiz.scorePerQuestion || 5;
                    document.getElementById('editQuizTimeLimit').value = quiz.timeLimit || 30;
                    document.getElementById('editQuizDeadline').value = quiz.deadline || '';
                    
                    // Set operation if claw machine
                    if (isSpecificClawMachineType(quiz.type)) {
                        document.getElementById('editOperationGroup').style.display = 'none';
                        document.getElementById('editQuizOperation').required = false;
                        document.getElementById('editQuizOperation').value = getClawOperationFromType(quiz.type);
                    } else if (quiz.type === 'clawmachine') {
                        document.getElementById('editOperationGroup').style.display = 'block';
                        document.getElementById('editQuizOperation').required = true;
                        document.getElementById('editQuizOperation').value = quiz.operation || '';
                    } else {
                        document.getElementById('editOperationGroup').style.display = 'none';
                        document.getElementById('editQuizOperation').required = false;
                        document.getElementById('editQuizOperation').value = '';
                    }
                    
                    // Load questions
                    const container = document.getElementById('editQuestionsContainer');
                    container.innerHTML = '';
                    editQuestionCounter = 0;
                    
                    if (quiz.questions && quiz.questions.length > 0) {
                        quiz.questions.forEach(question => {
                            addEditQuestionRow(question);
                        });
                    }
                    
                    // Open modal
                    const modal = document.getElementById('editQuizModal');
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            } catch (error) {
                console.error('Error loading quiz for edit:', error);
                alert('Error loading quiz details.');
            }
        }

        // Close edit quiz modal
        window.closeEditQuizModal = function() {
            const modal = document.getElementById('editQuizModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Clear message
            const messageDiv = document.getElementById('editQuizMessage');
            messageDiv.style.display = 'none';
        }

        // Update operation options for edit modal
        window.updateEditOperationOptions = function() {
            const quizType = document.getElementById('editQuizType').value;
            const operationGroup = document.getElementById('editOperationGroup');
            const operationSelect = document.getElementById('editQuizOperation');
            
            if (isSpecificClawMachineType(quizType)) {
                operationGroup.style.display = 'none';
                operationSelect.required = false;
                operationSelect.value = getClawOperationFromType(quizType);
                updateEditQuestionRowsForSpecificClawMachine(quizType);
            } else if (quizType === 'clawmachine') {
                operationGroup.style.display = 'block';
                operationSelect.required = true;
                updateEditQuestionRowsForClawMachine();
            } else if (quizType === 'openworld') {
                operationGroup.style.display = 'none';
                operationSelect.required = false;
                operationSelect.value = '';
                updateEditQuestionRowsForOpenWorld();
            } else {
                operationGroup.style.display = 'none';
                operationSelect.required = false;
            }
        }

        // Question counter for edit modal
        let editQuestionCounter = 0;

        // Add question row to edit modal
        window.addEditQuestionRow = function(questionData = null) {
            const quizType = document.getElementById('editQuizType').value;
            let selectedOperation = document.getElementById('editQuizOperation').value;
            const container = document.getElementById('editQuestionsContainer');
            
            editQuestionCounter++;
            const questionId = `edit_question_${editQuestionCounter}`;
            
            const questionRow = document.createElement('div');
            questionRow.className = 'question-row';
            questionRow.id = questionId;
            
            let operatorHTML = '';
            let operatorValue = questionData ? questionData.operator : '';
            
            if (isSpecificClawMachineType(quizType)) {
                selectedOperation = getClawOperationFromType(quizType);
                operatorValue = getOperationSymbol(selectedOperation);
                operatorHTML = `<input type="text" value="${operatorValue}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
            } else if (quizType === 'clawmachine' && selectedOperation) {
                const symbol = getOperationSymbol(selectedOperation);
                if (symbol) {
                    operatorValue = symbol;
                    operatorHTML = `<input type="text" value="${operatorValue}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
                } else {
                    operatorHTML = `<input type="text" placeholder="Op" readonly style="text-align: center; background-color: #f0f0f0;">`;
                }
            } else if (quizType === 'openworld' || questionData) {
                operatorHTML = `
                    <select class="operator-select" name="edit_operator_${editQuestionCounter}" required onchange="calculateAnswer('${questionId}')">
                        <option value="+" ${operatorValue === '+' ? 'selected' : ''}>+</option>
                        <option value="-" ${operatorValue === '-' ? 'selected' : ''}>-</option>
                        <option value="×" ${operatorValue === '×' ? 'selected' : ''}>×</option>
                        <option value="÷" ${operatorValue === '÷' ? 'selected' : ''}>÷</option>
                    </select>
                `;
            } else {
                operatorHTML = `<input type="text" placeholder="Op" readonly style="text-align: center; background-color: #f0f0f0;">`;
            }
            
            questionRow.innerHTML = `
                <input type="number" placeholder="First number" name="edit_num1_${editQuestionCounter}" value="${questionData ? questionData.num1 : ''}" required oninput="calculateAnswer('${questionId}')">
                ${operatorHTML}
                <input type="number" placeholder="Second number" name="edit_num2_${editQuestionCounter}" value="${questionData ? questionData.num2 : ''}" required oninput="calculateAnswer('${questionId}')">
                <span style="text-align: center; font-weight: 600; font-size: 18px;">=</span>
                <input type="number" placeholder="Answer" name="edit_answer_${editQuestionCounter}" value="${questionData ? questionData.answer : ''}" required readonly style="background-color: rgba(34, 197, 94, 0.1); color: #15803d; font-weight: 600;">
                <button type="button" class="remove-btn" onclick="removeEditQuestionRow('${questionId}')" title="Remove question">×</button>
            `;
            
            container.appendChild(questionRow);
        }

        // Remove question row from edit modal
        window.removeEditQuestionRow = function(questionId) {
            const row = document.getElementById(questionId);
            if (row) {
                row.remove();
            }
        }

        // Update question rows for claw machine in edit modal
        function updateEditQuestionRowsForClawMachine() {
            const selectedOperation = document.getElementById('editQuizOperation').value;
            const rows = document.querySelectorAll('#editQuestionsContainer .question-row');
            rows.forEach(row => {
                const operatorElement = row.children[1];
                if (selectedOperation) {
                    const symbol = getOperationSymbol(selectedOperation);
                    if (symbol) {
                        operatorElement.outerHTML = `<input type="text" value="${symbol}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
                    }
                }
            });
        }

        function updateEditQuestionRowsForSpecificClawMachine(quizType) {
            const operation = getClawOperationFromType(quizType);
            const symbol = getOperationSymbol(operation);
            if (!symbol) {
                return;
            }

            const rows = document.querySelectorAll('#editQuestionsContainer .question-row');
            rows.forEach(row => {
                const operatorElement = row.children[1];
                operatorElement.outerHTML = `<input type="text" value="${symbol}" readonly style="text-align: center; font-weight: 600; background-color: rgba(102, 126, 234, 0.1);">`;
            });
        }

        // Update question rows for open world in edit modal
        function updateEditQuestionRowsForOpenWorld() {
            const rows = document.querySelectorAll('#editQuestionsContainer .question-row');
            rows.forEach((row, index) => {
                const operatorElement = row.children[1];
                const questionNum = index + 1;
                operatorElement.outerHTML = `
                    <select class="operator-select" name="edit_operator_${questionNum}" required>
                        <option value="+">+</option>
                        <option value="-">-</option>
                        <option value="×">×</option>
                        <option value="÷">÷</option>
                    </select>
                `;
            });
        }

        // Update quiz with new data
        window.updateQuiz = async function(event) {
            event.preventDefault();
            
            const quizId = document.getElementById('editQuizId').value;
            const quizName = document.getElementById('editQuizName').value.trim();
            const quizType = document.getElementById('editQuizType').value;
            const operation = document.getElementById('editQuizOperation').value;
            const attempts = parseInt(document.getElementById('editQuizAttempts').value);
            const scorePerQuestion = parseInt(document.getElementById('editQuizScore').value);
            const timeLimit = parseInt(document.getElementById('editQuizTimeLimit').value);
            const deadline = document.getElementById('editQuizDeadline').value;
            const container = document.getElementById('editQuestionsContainer');
            const questionRows = container.querySelectorAll('.question-row');
            
            if (questionRows.length === 0) {
                showEditQuizMessage('Please add at least one question.', 'error');
                return;
            }
            
            // Collect all questions
            const questions = [];
            questionRows.forEach((row, index) => {
                const inputs = row.querySelectorAll('input[type="number"]');
                const operatorElement = row.children[1];
                
                let operator = '';
                if (isSpecificClawMachineType(quizType)) {
                    operator = getOperationSymbol(getClawOperationFromType(quizType));
                } else if (quizType === 'clawmachine' || quizType === 'openworld') {
                    operator = operatorElement.value;
                }

                if (!operator || operator.trim() === '' || operator.toLowerCase() === 'op') {
                    const resolvedOp = resolveOperationValue(quizType, operation);
                    if (resolvedOp && resolvedOp !== 'mixed') {
                        operator = getOperationSymbol(resolvedOp) || operator;
                    }
                }
                
                questions.push({
                    num1: parseInt(inputs[0].value),
                    operator: operator,
                    num2: parseInt(inputs[1].value),
                    answer: parseInt(inputs[2].value)
                });
            });
            
            try {
                // Get existing quiz to preserve student results
                const quizRef = ref(database, 'quizzes/' + quizId);
                const snapshot = await get(quizRef);
                const existingQuiz = snapshot.exists() ? snapshot.val() : {};
                
                // Update quiz object
                const updatedQuiz = {
                    name: quizName,
                    type: quizType,
                    operation: resolveOperationValue(quizType, operation),
                    attempts: attempts,
                    scorePerQuestion: scorePerQuestion,
                    timeLimit: timeLimit,
                    deadline: deadline,
                    questions: questions,
                    createdAt: existingQuiz.createdAt || new Date().toISOString(),
                    questionCount: questions.length,
                    studentResults: existingQuiz.studentResults || {}
                };
                
                // Save to Firebase
                await set(quizRef, updatedQuiz);
                
                showEditQuizMessage('Quiz updated successfully!', 'success');
                
                // Refresh quiz list and close modal after short delay
                setTimeout(() => {
                    loadQuizzes();
                    closeEditQuizModal();
                }, 1500);
                
            } catch (error) {
                console.error('Error updating quiz:', error);
                showEditQuizMessage('Error updating quiz. Please try again.', 'error');
            }
        }

        function showEditQuizMessage(message, type) {
            const messageDiv = document.getElementById('editQuizMessage');
            messageDiv.textContent = message;
            messageDiv.className = type === 'success' ? 'message success' : 'message error';
            messageDiv.style.display = 'block';
        }

        // Delete quiz
        window.deleteQuiz = async function(quizId) {
            if (!confirm('Are you sure you want to delete this quiz? This action cannot be undone.')) {
                return;
            }
            
            try {
                // Clear Unity quiz results for this quiz
                console.log('[Unity Integration] Clearing results for deleted quiz:', quizId);
                await window.ClearQuizResults(quizId);
                
                // Delete the quiz from Firebase
                const quizRef = ref(database, 'quizzes/' + quizId);
                await set(quizRef, null);
                
                alert('Quiz deleted successfully!');
                loadQuizzes();
            } catch (error) {
                console.error('Error deleting quiz:', error);
                alert('Error deleting quiz. Please try again.');
            }
        }

        // Initialize admin credentials display
        function initializeAdminDisplay() {
            const usernameDisplay = document.getElementById('adminUsernameDisplay');
            if (usernameDisplay) {
                usernameDisplay.textContent = ADMIN_USERNAME;
            }
        }

        // Fetch and display all created accounts from Firebase
        async function loadRecentlyCreatedAccounts() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const users = [];
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        const userId = childSnapshot.key;
                        
                        // Only include non-admin users
                        if (!userData.isAdmin) {
                            users.push({
                                id: userId,
                                fullname: userData.fullname || 'N/A',
                                username: userData.username || 'N/A',
                                email: userData.email || 'N/A',
                                createdAt: userData.createdAt || new Date().toISOString(),
                                score: userData.score || 0
                            });
                        }
                    });
                    
                    // Sort by creation date (newest first)
                    users.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    
                    // Show ALL users (no limit)
                    updateRecentAccountsTable(users);
                } else {
                    console.log('No users found in database');
                    updateRecentAccountsTable([]);
                }
            } catch (error) {
                console.error('Error loading recent accounts:', error);
            }
        }

        // Update the Recently Created Accounts table
        function updateRecentAccountsTable(users) {
            const tableBody = document.getElementById('recentAccountsTableBody');
            
            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6c7aa0;">
                            No students registered yet. Create the first student account!
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = users.map((user, index) => {
                const createdDate = new Date(user.createdAt);
                const formattedDate = createdDate.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                
                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="account-checkbox" data-account-id="${user.id}" onchange="updateDeleteButton()" style="width: 18px; height: 18px; cursor: pointer; accent-color: #667eea;">
                        </td>
                        <td>${user.fullname}</td>
                        <td>${user.username}</td>
                        <td>${user.email}</td>
                        <td>${formattedDate}</td>
                        <td><span class="pill" style="background-color: rgba(34, 197, 94, 0.15); color: #15803d;">Active</span></td>
                        <td>
                            <div class="user-row-actions">
                                <button class="small-btn" onclick="editAccountDetails('${user.id}')">✏️ Edit</button>
                                <button class="small-btn" style="background-color: rgba(239, 68, 68, 0.12); color: #dc2626;" onclick="deleteAccount('${user.id}')">🗑️ Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Fetch and display ALL students in Students tab
        async function loadAllStudents() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                if (snapshot.exists()) {
                    const students = [];
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        const userId = childSnapshot.key;
                        
                        // Only include non-admin users
                        if (!userData.isAdmin) {
                            students.push({
                                id: userId,
                                fullname: userData.fullname || 'N/A',
                                username: userData.username || 'N/A',
                                email: userData.email || 'N/A',
                                cwHighScore: userData.CWHighScore || 0,
                                opHighScore: userData.OPHighScore || 0,
                                createdAt: userData.createdAt || new Date().toISOString()
                            });
                        }
                    });
                    
                    // Sort by name alphabetically
                    students.sort((a, b) => a.fullname.localeCompare(b.fullname));
                    
                    // Update the Students tab table
                    updateAllStudentsTable(students);
                    
                    // Update dashboard statistics
                    updateDashboardStats(students);
                } else {
                    console.log('No students found in database');
                    updateAllStudentsTable([]);
                    updateDashboardStats([]);
                }
            } catch (error) {
                console.error('Error loading all students:', error);
            }
        }

        // Update the All Students table (Students tab)
        function updateAllStudentsTable(students) {
            const tableBody = document.getElementById('studentsTableBody');
            
            if (students.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 40px; color: #6c7aa0;">
                            No students found. Register students in the Manage Account tab!
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = students.map((student) => {
                return `
                    <tr>
                        <td>${student.fullname}</td>
                        <td>${student.email}</td>
                        <td>${student.cwHighScore}</td>
                        <td>${student.opHighScore}</td>
                        <td>
                            <div class="user-row-actions">
                                <button class="small-btn" onclick="viewStudent('${student.id}')">👁️ View</button>
                                <button class="small-btn" onclick="archiveStudent('${student.id}')">📦 Archive</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }


        // View student details
        window.viewStudent = async function(studentId) {
            try {
                // Fetch student data from Firebase
                const userRef = ref(database, 'users/' + studentId);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    
                    // Format the student information
                    const studentInfo = `
                        <div style="display: grid; gap: 24px;">
                            <!-- Basic Information -->
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white;">
                                <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">👤 Basic Information</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div>
                                        <strong>Full Name:</strong><br>
                                        <span style="font-size: 14px; opacity: 0.9;">${userData.fullname || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong>Username:</strong><br>
                                        <span style="font-size: 14px; opacity: 0.9;">${userData.username || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong>Email:</strong><br>
                                        <span style="font-size: 14px; opacity: 0.9;">${userData.email || 'N/A'}</span>
                                    </div>
                                    <div>
                                        <strong>Account Created:</strong><br>
                                        <span style="font-size: 14px; opacity: 0.9;">${userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : 'N/A'}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Game Scores -->
                            <div style="background: #f8f9fe; padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #323f90;">🎮 Game Performance</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                        <div style="font-size: 24px; margin-bottom: 8px;">🎮</div>
                                        <div style="font-weight: 600; color: #323f90; margin-bottom: 4px;">Claw Machine</div>
                                        <div style="font-size: 28px; font-weight: 700; color: #667eea;">${userData.CWHighScore || 0}</div>
                                        <div style="font-size: 12px; color: #6c7aa0;">High Score</div>
                                    </div>
                                    <div style="text-align: center; padding: 16px; background: white; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                        <div style="font-size: 24px; margin-bottom: 8px;">🌍</div>
                                        <div style="font-weight: 600; color: #323f90; margin-bottom: 4px;">Open World</div>
                                        <div style="font-size: 28px; font-weight: 700; color: #667eea;">${userData.OPHighScore || 0}</div>
                                        <div style="font-size: 12px; color: #6c7aa0;">High Score</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Game History -->
                            <div style="background: #f8f9fe; padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #323f90;">📊 Game History</h3>
                                <div style="display: grid; gap: 12px;">
                                    ${userData.completedGames ? `
                                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                            <strong>Completed Games:</strong> ${Object.keys(userData.completedGames).length} games
                                        </div>
                                    ` : '<div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); color: #6c7aa0;">No completed games yet</div>'}
                                    
                                    ${userData.mixedOperationsGames ? `
                                        <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                            <strong>Mixed Operations Games:</strong> ${Object.keys(userData.mixedOperationsGames).length} games
                                        </div>
                                    ` : '<div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1); color: #6c7aa0;">No mixed operations games yet</div>'}
                                </div>
                            </div>

                            <!-- Additional Stats -->
                            <div style="background: #f8f9fe; padding: 20px; border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                <h3 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600; color: #323f90;">📈 Additional Statistics</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                        <strong>Total Score:</strong><br>
                                        <span style="color: #667eea; font-weight: 600;">${userData.score || 0}</span>
                                    </div>
                                    <div style="background: white; padding: 12px; border-radius: 8px; border: 1px solid rgba(102, 126, 234, 0.1);">
                                        <strong>Account Status:</strong><br>
                                        <span style="color: #10b981; font-weight: 600;">${userData.isAdmin ? 'Admin' : 'Student'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Update modal content
                    document.getElementById('studentViewContent').innerHTML = studentInfo;
                    
                    // Open modal
                    const modal = document.getElementById('studentViewModal');
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                } else {
                    alert('Student not found in database.');
                }
            } catch (error) {
                console.error('Error loading student details:', error);
                alert('Error loading student details. Please try again.');
            }
        }

        // Close student view modal
        window.closeStudentViewModal = function() {
            const modal = document.getElementById('studentViewModal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Archive student
        window.archiveStudent = async function(studentId) {
            const confirmMsg = 'Are you sure you want to archive this student? They will be moved to archived students.';
            if (confirm(confirmMsg)) {
                alert(`Student ${studentId} has been archived.\n\nIn production, this would:\n- Move student to archived collection\n- Maintain student data for records\n- Remove from active student list`);
                // In production: update student status to archived in Firebase
            }
        }

        // Leaderboard Logic (based on Unity LegacyLeaderboardManager)
        let currentLeaderboardMode = 'CLAW MACHINE'; // 'CLAW MACHINE' or 'OPEN WORLD'
        let currentMathFilter = ''; // For Claw Machine: '', 'Addition', 'Subtraction', 'Multiplication', 'Division'

        async function loadLeaderboard() {
            try {
                const usersRef = ref(database, 'users');
                const snapshot = await get(usersRef);
                
                const topUsers = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach((childSnapshot) => {
                        const userData = childSnapshot.val();
                        const userId = childSnapshot.key;
                        
                        // Skip admin users
                        if (userData.isAdmin) return;
                        
                        const username = userData.username || userData.fullname || 'Unknown';
                        let bestScore = 0;
                        
                        if (currentLeaderboardMode === 'OPEN WORLD') {
                            // OPEN WORLD = Mixed Operations only
                            const mixedGames = userData.mixedOperationsGames;
                            if (mixedGames) {
                                Object.values(mixedGames).forEach(game => {
                                    const gameScore = parseInt(game.finalScore) || 0;
                                    bestScore = Math.max(bestScore, gameScore);
                                });
                            }
                        } else {
                            // CLAW MACHINE = Addition, Subtraction, Multiplication, Division
                            const completedGames = userData.completedGames;
                            if (completedGames) {
                                Object.values(completedGames).forEach(game => {
                                    const mathOp = game.mathOperation;
                                    const gameScore = parseInt(game.finalScore) || 0;
                                    
                                    // Filter by math operation if specified
                                    if (!currentMathFilter || mathOp === currentMathFilter) {
                                        bestScore = Math.max(bestScore, gameScore);
                                    }
                                });
                            }
                            
                            // Fallback to main score for "All" view in Claw Machine
                            if (bestScore === 0 && !currentMathFilter) {
                                bestScore = parseInt(userData.score) || 0;
                            }
                        }
                        
                        if (bestScore > 0) {
                            topUsers.push({ username, bestScore });
                        }
                    });
                }
                
                // Sort by best score (highest first) and take top 10
                topUsers.sort((a, b) => b.bestScore - a.bestScore);
                const top10 = topUsers.slice(0, 10);
                
                // Fill the leaderboard rows
                fillLeaderboardRows(top10);
                
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        function fillLeaderboardRows(users) {
            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '';
            
            // Define medal emojis for top 3
            const medals = ['🥇', '🥈', '🥉'];
            
            // Create rows for top 10
            for (let i = 0; i < 10; i++) {
                const rank = i + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : 'rank-other';
                const badge = rank <= 3 ? `${medals[i]} #${rank}` : `👤 #${rank}`;
                
                const username = i < users.length ? users[i].username : '---';
                const score = i < users.length ? users[i].bestScore : '0';
                
                const rowHTML = `
                    <div class="leaderboard-row ${rankClass}">
                        <div class="rank-badge">${badge}</div>
                        <div class="player-info">
                            <div class="player-name">${username}</div>
                            <div class="player-score">${score}</div>
                        </div>
                    </div>
                `;
                
                container.innerHTML += rowHTML;
            }
        }

        function updateFilterButtons() {
            const filterButtonsContainer = document.getElementById('filterButtons');
            
            if (currentLeaderboardMode === 'OPEN WORLD') {
                // Open World: No filters, just show info
                filterButtonsContainer.innerHTML = `
                    <div class="tag" style="background-color: rgba(118, 75, 162, 0.15); color: #764ba2; font-size: 14px;">
                        🌍 Mixed operations
                    </div>
                `;
            } else {
                // Claw Machine: Show operation filters
                filterButtonsContainer.innerHTML = `
                    <button class="small-btn filter-btn active" onclick="filterLeaderboard('')">All</button>
                    <button class="small-btn filter-btn" onclick="filterLeaderboard('Addition')">Addition</button>
                    <button class="small-btn filter-btn" onclick="filterLeaderboard('Subtraction')">Subtraction</button>
                    <button class="small-btn filter-btn" onclick="filterLeaderboard('Multiplication')">Multiplication</button>
                    <button class="small-btn filter-btn" onclick="filterLeaderboard('Division')">Division</button>
                `;
            }
        }

        window.filterLeaderboard = function(mathOperation) {
            currentMathFilter = mathOperation;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Reload leaderboard with new filter
            loadLeaderboard();
        }

        window.toggleLeaderboardMode = function() {
            if (currentLeaderboardMode === 'CLAW MACHINE') {
                currentLeaderboardMode = 'OPEN WORLD';
                currentMathFilter = ''; // Reset filter when switching modes
                document.getElementById('leaderboardTitle').textContent = '🏆 OPEN WORLD Leaderboard';
                document.getElementById('toggleModeText').textContent = 'Switch to CLAW MACHINE';
            } else {
                currentLeaderboardMode = 'CLAW MACHINE';
                currentMathFilter = ''; // Reset filter when switching modes
                document.getElementById('leaderboardTitle').textContent = '🏆 CLAW MACHINE Leaderboard';
                document.getElementById('toggleModeText').textContent = 'Switch to OPEN WORLD';
            }
            
            // Update filter buttons based on mode
            updateFilterButtons();
            
            // Reload leaderboard for new mode
            loadLeaderboard();
        }

        // Search users in Recently Created Accounts table
        window.searchUsers = function() {
            const searchInput = document.getElementById('userSearchInput');
            const filter = searchInput.value.toLowerCase().trim();
            const table = document.getElementById('recentAccountsTableBody');
            const rows = table.getElementsByTagName('tr');
            const clearBtn = document.getElementById('clearSearchBtn');
            const searchResults = document.getElementById('searchResults');
            
            let visibleCount = 0;
            let totalCount = rows.length;

            // Show/hide clear button
            clearBtn.style.display = filter ? 'block' : 'none';

            // Loop through all table rows
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                let found = false;

                if (cells.length > 0) {
                    // Get text from Full Name (index 1), Username (index 2), and Email (index 3)
                    const fullName = cells[1]?.textContent || '';
                    const username = cells[2]?.textContent || '';
                    const email = cells[3]?.textContent || '';

                    // Check if search term matches any field
                    if (fullName.toLowerCase().includes(filter) || 
                        username.toLowerCase().includes(filter) || 
                        email.toLowerCase().includes(filter)) {
                        found = true;
                    }
                }

                // Show or hide row based on search
                if (found || filter === '') {
                    rows[i].style.display = '';
                    visibleCount++;
                } else {
                    rows[i].style.display = 'none';
                }
            }

            // Update search results text
            if (filter) {
                if (visibleCount === 0) {
                    searchResults.textContent = `No users found matching "${filter}"`;
                    searchResults.style.color = '#dc2626';
                } else if (visibleCount === totalCount) {
                    searchResults.textContent = `Showing all ${totalCount} users`;
                    searchResults.style.color = '#6c7aa0';
                } else {
                    searchResults.textContent = `Found ${visibleCount} of ${totalCount} users`;
                    searchResults.style.color = '#15803d';
                }
            } else {
                searchResults.textContent = '';
            }

            // Update the select all checkbox and delete button based on visible rows
            updateDeleteButton();
        }

        // Clear search
        window.clearSearch = function() {
            const searchInput = document.getElementById('userSearchInput');
            searchInput.value = '';
            searchUsers();
            searchInput.focus();
        }

        // Unity Communication Functions
        // Store the current operation type and quiz ID for Unity quiz results
        let currentUnityOperation = 'mixed';
        let currentUnityQuizId = null;
        let currentClawQuizId = null;
        
        // Function for Unity to set the current operation type
        window.SetUnityOperation = function(operation) {
            currentUnityOperation = operation || 'mixed';
            console.log('[Unity Integration] Unity operation set to:', currentUnityOperation);
        };
        
        // Function for Unity to set the current quiz ID (Open World Game)
        window.SetUnityQuizId = function(quizId) {
            console.log('[Unity Integration] SetUnityQuizId called with quizId:', quizId);
            currentUnityQuizId = quizId;
            
            // Clear old quiz results when setting new quiz ID
            if (quizId) {
                console.log('[Unity Integration] Clearing all old quiz results...');
                // The results will be stored under the new quiz-specific path
            }
            
            console.log('[Unity Integration] Unity quiz ID set to:', currentUnityQuizId);
        };
        
        // Function for Unity to set the current ClawQuiz ID
        window.SetClawQuizId = function(quizId) {
            console.log('[Unity Integration] SetClawQuizId called with quizId:', quizId);
            currentClawQuizId = quizId;
            
            // Clear old ClawQuiz results when setting new quiz ID
            if (quizId) {
                console.log('[Unity Integration] Clearing all old ClawQuiz results...');
                // The results will be stored under the new quiz-specific path
            }
            
            console.log('[Unity Integration] ClawQuiz ID set to:', currentClawQuizId);
        };
        
        // Function to clear Unity quiz ID (call this when creating a new quiz)
        window.ClearUnityQuizId = function() {
            currentUnityQuizId = null;
            console.log('[Unity Integration] Unity quiz ID cleared');
        };
        
        // Function to clear ClawQuiz ID
        window.ClearClawQuizId = function() {
            currentClawQuizId = null;
            console.log('[Unity Integration] ClawQuiz ID cleared');
        };
        
        // Function to check if Unity integration is ready
        window.IsUnityIntegrationReady = function() {
            console.log('[Unity Integration] Unity integration ready check');
            return {
                ready: true,
                currentUnityQuizId: currentUnityQuizId,
                currentClawQuizId: currentClawQuizId,
                currentUnityOperation: currentUnityOperation,
                timestamp: new Date().toISOString()
            };
        };
        
        // Function to clear all old Firebase structure results (for cleanup)
        window.ClearAllOldResults = async function() {
            try {
                console.log('[Unity Integration] Clearing all old Firebase structure results...');
                
                const operations = ['addition', 'subtraction', 'multiplication', 'division', 'mixed'];
                for (const operation of operations) {
                    const operationPath = `quizManagement/${operation}`;
                    const operationRef = ref(database, operationPath);
                    await set(operationRef, null);
                    console.log(`[Unity Integration] Cleared old results for operation: ${operation}`);
                }
                
                console.log('[Unity Integration] Successfully cleared all old Firebase structure results');
                return true;
            } catch (error) {
                console.error('[Unity Integration] Error clearing all old results:', error);
                return false;
            }
        };
        
        // Function to clear results for a specific quiz ID
        window.ClearQuizResults = async function(quizId) {
            try {
                console.log('[Unity Integration] ClearQuizResults called with quizId:', quizId);
                if (!quizId) {
                    console.warn('[Unity Integration] No quiz ID provided for clearing results');
                    return false;
                }
                
                // Get the quiz data to determine the operation type
                let operationType = 'mixed';
                try {
                    const quizRef = ref(database, 'quizzes/' + quizId);
                    const quizSnapshot = await get(quizRef);
                    if (quizSnapshot.exists()) {
                        const quizData = quizSnapshot.val();
                        operationType = quizData.operation || 'mixed';
                        console.log(`[Unity Integration] Quiz operation type: ${operationType}`);
                    }
                } catch (error) {
                    console.warn('[Unity Integration] Could not get quiz data, using default operation type');
                }
                
                // Clear results from quizResults structure: quizResults/{quizId}
                const resultsPath = `quizResults/${quizId}`;
                const resultsRef = ref(database, resultsPath);
                await set(resultsRef, null);
                
                // Clear ALL results from the operation type (e.g., all addition results)
                const operationPath = `quizResults/${operationType}`;
                const operationRef = ref(database, operationPath);
                await set(operationRef, null);
                console.log(`[Unity Integration] Cleared ALL results for operation: ${operationType}`);
                
                console.log('[Unity Integration] Successfully cleared results for quiz:', quizId);
                return true;
            } catch (error) {
                console.error('[Unity Integration] Error clearing quiz results:', error);
                return false;
            }
        };
        
        // Function to clear results for a specific ClawQuiz ID
        window.ClearClawQuizResults = async function(quizId) {
            try {
                console.log('[Unity Integration] ClearClawQuizResults called with quizId:', quizId);
                if (!quizId) {
                    console.warn('[Unity Integration] No ClawQuiz ID provided for clearing results');
                    return false;
                }
                
                // Get the quiz data to determine the operation type
                let operationType = 'mixed';
                try {
                    const quizRef = ref(database, 'quizzes/' + quizId);
                    const quizSnapshot = await get(quizRef);
                    if (quizSnapshot.exists()) {
                        const quizData = quizSnapshot.val();
                        operationType = quizData.operation || 'mixed';
                        console.log(`[Unity Integration] ClawQuiz operation type: ${operationType}`);
                    }
                } catch (error) {
                    console.warn('[Unity Integration] Could not get ClawQuiz data, using default operation type');
                }
                
                // Clear results from new structure: quizManagement/{quizId}
                const resultsPath = `quizManagement/${quizId}`;
                const resultsRef = ref(database, resultsPath);
                await set(resultsRef, null);
                
                // Clear ALL results from the operation type (e.g., all addition results)
                const operationPath = `quizManagement/${operationType}`;
                const operationRef = ref(database, operationPath);
                await set(operationRef, null);
                console.log(`[Unity Integration] Cleared ALL ClawQuiz results for operation: ${operationType}`);
                
                console.log('[Unity Integration] Successfully cleared ClawQuiz results for quiz:', quizId);
                return true;
            } catch (error) {
                console.error('[Unity Integration] Error clearing ClawQuiz results:', error);
                return false;
            }
        };
        
        window.SubmitQuizResult = async function(quizResultData) {
            try {
                console.log('[Unity Integration] Submitting result for quiz ID:', currentUnityQuizId);
                console.log('[Unity Integration] Received quiz result from Unity:', quizResultData);
                
                // Validate the quiz result data
                if (!quizResultData || typeof quizResultData !== 'object') {
                    console.error('[Unity Integration] Invalid quiz result data received from Unity');
                    return false;
                }

                // Extract fields from Unity data structure
                const {
                    username,
                    fullName,
                    score,
                    correct,
                    incorrect,
                    answered,
                    timeSeconds,
                    timestampUtc
                } = quizResultData;

                // Validate required fields from Unity
                if (!username || score === undefined) {
                    console.error('[Unity Integration] Missing required fields in quiz result data:', { username, score });
                    return false;
                }

                // Use current Unity quiz ID or generate one
                const quizId = currentUnityQuizId || `unity_${Date.now()}`;
                
                // Determine operation type from quiz ID or use current operation
                let operationType = 'mixed';
                if (quizId.includes('addition')) operationType = 'addition';
                else if (quizId.includes('subtraction')) operationType = 'subtraction';
                else if (quizId.includes('multiplication')) operationType = 'multiplication';
                else if (quizId.includes('division')) operationType = 'division';
                else operationType = currentUnityOperation;

                // Create the result object matching Unity's expected structure
                const resultData = {
                    username: username,
                    fullName: fullName || username,
                    score: Number(score) || 0,
                    correct: Number(correct) || 0,
                    incorrect: Number(incorrect) || 0,
                    answered: Number(answered) || 0,
                    timeSeconds: Number(timeSeconds) || 0,
                    timestampUtc: timestampUtc || new Date().toISOString(),
                    operation: operationType,
                    quizId: quizId,
                    submittedAt: new Date().toISOString(),
                    source: 'unity'
                };

                // Store in Firebase structure that Unity expects: quizManagement/{operationKey}/{userKey}
                const operationPath = `quizManagement/${operationType}`;
                const userPath = `${operationPath}/${username}`;
                const userRef = ref(database, userPath);
                
                // Get current user data
                const userSnapshot = await get(userRef);
                const currentData = userSnapshot.exists() ? userSnapshot.val() : {};
                
                // Update user data with new result
                const updatedData = {
                    attemptsUsed: (currentData.attemptsUsed || 0) + 1,
                    bestScore: Math.max(currentData.bestScore || 0, resultData.score),
                    lastResult: resultData
                };
                
                await set(userRef, updatedData);

                console.log('[Unity Integration] Quiz result saved successfully to Firebase:');
                console.log('[Unity Integration] Operation path:', operationPath);
                console.log('[Unity Integration] User path:', userPath);
                console.log('[Unity Integration] Result data:', resultData);
                return true;

            } catch (error) {
                console.error('[Unity Integration] Error saving quiz result to Firebase:', error);
                return false;
            }
        };
        
        // ClawQuiz-specific submit function
        window.SubmitClawQuizResult = async function(quizResultData) {
            try {
                console.log('[Unity Integration] Submitting ClawQuiz result for quiz ID:', currentClawQuizId);
                console.log('[Unity Integration] Received ClawQuiz result from Unity:', quizResultData);
                
                // Validate the quiz result data
                if (!quizResultData || typeof quizResultData !== 'object') {
                    console.error('[Unity Integration] Invalid ClawQuiz result data received from Unity');
                    return false;
                }

                // Extract fields from Unity data structure
                const {
                    username,
                    fullName,
                    score,
                    correct,
                    incorrect,
                    answered,
                    timeSeconds,
                    timestampUtc
                } = quizResultData;

                // Validate required fields from Unity
                if (!username || score === undefined) {
                    console.error('[Unity Integration] Missing required fields in ClawQuiz result data:', { username, score });
                    return false;
                }

                // Use current ClawQuiz ID or generate one
                const quizId = currentClawQuizId || `claw_quiz_${Date.now()}`;
                
                // Determine operation type from quiz ID or use current operation
                let operationType = 'mixed';
                if (quizId.includes('addition')) operationType = 'addition';
                else if (quizId.includes('subtraction')) operationType = 'subtraction';
                else if (quizId.includes('multiplication')) operationType = 'multiplication';
                else if (quizId.includes('division')) operationType = 'division';
                else operationType = currentUnityOperation;

                // Create the result object matching Unity's expected structure
                const resultData = {
                    username: username,
                    fullName: fullName || username,
                    score: Number(score) || 0,
                    correct: Number(correct) || 0,
                    incorrect: Number(incorrect) || 0,
                    answered: Number(answered) || 0,
                    timeSeconds: Number(timeSeconds) || 0,
                    timestampUtc: timestampUtc || new Date().toISOString(),
                    operation: operationType,
                    quizId: quizId,
                    submittedAt: new Date().toISOString(),
                    source: 'unity_clawquiz'
                };

                // Store in Firebase structure that Unity expects: quizManagement/{operationKey}/{userKey}
                const operationPath = `quizManagement/${operationType}`;
                const userPath = `${operationPath}/${username}`;
                const userRef = ref(database, userPath);
                
                // Get current user data
                const userSnapshot = await get(userRef);
                const currentData = userSnapshot.exists() ? userSnapshot.val() : {};
                
                // Update user data with new result
                const updatedData = {
                    attemptsUsed: (currentData.attemptsUsed || 0) + 1,
                    bestScore: Math.max(currentData.bestScore || 0, resultData.score),
                    lastResult: resultData
                };
                
                await set(userRef, updatedData);

                console.log('[Unity Integration] ClawQuiz result saved successfully to Firebase:');
                console.log('[Unity Integration] Operation path:', operationPath);
                console.log('[Unity Integration] User path:', userPath);
                console.log('[Unity Integration] Result data:', resultData);
                return true;

            } catch (error) {
                console.error('[Unity Integration] Error saving ClawQuiz result to Firebase:', error);
                return false;
            }
        };

        // Download App Functions
        window.downloadAPK = function() {
            // In a real implementation, this would download the actual APK file
            // For now, we'll show a message and simulate the download
            alert('📱 APK Download\n\nIn a real implementation, this would download the MatheMahika APK file (~200MB).\n\nFor now, you can:\n1. Build the Unity project for Android\n2. Export as APK (expect ~200MB file size)\n3. Host the APK file on your server\n4. Update this function to point to the actual file URL.\n\nNote: Ensure devices have 6-8GB RAM for optimal performance.');
            
            // Simulate download (replace with actual APK URL)
            // window.open('https://your-server.com/mathemahika.apk', '_blank');
        };


        // Update email preview as user types username
        window.updateEmailPreview = function() {
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            
            if (usernameInput && emailInput) {
                const username = usernameInput.value.trim();
                if (username) {
                    emailInput.value = `${username}@mathemahika.com`;
                } else {
                    emailInput.value = '';
                }
            }
        };

        // Make functions globally available
        window.handleRegistration = handleRegistration;
        window.resetForm = resetForm;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize admin credentials display
            initializeAdminDisplay();
            
            // Set up admin login submission
            const adminLoginForm = document.getElementById('adminLoginForm');
            adminLoginForm.addEventListener('submit', handleAdminLogin);
            
            // Set up registration submission
            const form = document.getElementById('registrationForm');
            form.addEventListener('submit', handleRegistration);
            
            // Navigation handling
            const navItems = document.querySelectorAll('.nav-item[data-section]');
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const section = item.getAttribute('data-section');
                    updateSidebarState(section);
                });
            });

            // Restore last viewed section if available
            const savedSection = localStorage.getItem('currentSection');
            if (savedSection && adminAuthenticated) {
                updateSidebarState(savedSection);
            }

            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', () => {
                adminAuthenticated = false;
                const connectionStatus = document.getElementById('connectionStatus');
                const loginContainer = document.getElementById('adminLoginContainer');
                const registrationContainer = document.getElementById('registrationContainer');

                loginContainer.classList.remove('hidden');
                registrationContainer.classList.add('hidden');
                connectionStatus.classList.add('hidden');

                showLoginMessage('You have been signed out.', 'success');

                if (connectionIntervalId) {
                    clearInterval(connectionIntervalId);
                    connectionIntervalId = null;
                }
            });

            const updatePasswordBtn = document.getElementById('updatePasswordBtn');
            updatePasswordBtn.addEventListener('click', () => {
                const newPasswordInput = document.getElementById('newAdminPassword');
                const newPassword = newPasswordInput.value.trim();
                const accountMessage = document.getElementById('accountMessage');

                if (!newPassword || newPassword.length < 6) {
                    accountMessage.textContent = 'Password must be at least 6 characters long.';
                    accountMessage.className = 'message error';
                    accountMessage.style.display = 'block';
                    return;
                }

                // Demo only – would persist securely in production
                accountMessage.textContent = 'Password updated locally. Please store securely.';
                accountMessage.className = 'message success';
                accountMessage.style.display = 'block';
                newPasswordInput.value = '';
            });
        });
    </script>
</body>
</html>
